<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Precise Influencer Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f172a;
      --panel: #1e293b;
      --accent: #38bdf8;
      --muted: #94a3b8;
      --danger: #f87171;
      --success: #34d399;
      --border: #334155;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html {
      font-size: 0.85rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #e2e8f0;
      line-height: 1.35;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      font-size: 0.85rem;
    }

    header {
      padding: 1.5rem 2rem;
      background: linear-gradient(120deg, rgba(56, 189, 248, 0.25), rgba(99, 102, 241, 0.25));
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }

    header h1 {
      margin: 0 0 0.25rem;
      font-size: 1.85rem;
      letter-spacing: 0.04em;
    }

    header p {
      margin: 0;
      color: var(--muted);
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1fr) 360px;
      gap: 1.1rem;
      padding: 1.1rem;
      font-size: 0.85rem;
    }

    @media (max-width: 1200px) {
      main {
        grid-template-columns: 1fr;
      }

      aside {
        position: static;
        top: auto;
        height: auto;
      }
    }

    section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 24px 48px -32px rgba(15, 23, 42, 0.8);
    }

    section h2 {
      margin-top: 0;
      margin-bottom: 0.65rem;
      font-size: 1rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #cbd5f5;
    }

    #gating-section h2 {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .gating-grid {
      display: grid;
      gap: 0.45rem;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .gating-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.45rem 0.55rem;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.12);
      background: rgba(15, 23, 42, 0.35);
    }

    .gating-item label {
      flex: 1;
      font-weight: 500;
      font-size: 0.8rem;
      line-height: 1.35;
      cursor: pointer;
    }

    .approver-tag {
      font-size: 0.7rem;
      color: var(--muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead th {
      text-align: left;
      padding: 0.4rem;
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.06em;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    tbody td {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.08);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    select,
    input[type="number"],
    input[type="text"] {
      width: 100%;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 6px;
      color: inherit;
      padding: 0.35rem 0.4rem;
      font-size: 0.8rem;
    }

    .readonly-value {
      padding: 0.25rem 0;
      border-radius: 0;
      border: none;
      background: transparent;
      font-size: 0.8rem;
      font-variant-numeric: tabular-nums;
    }

    input[type="checkbox"] {
      accent-color: var(--accent);
      width: 1.1rem;
      height: 1.1rem;
      cursor: pointer;
    }

    .table-actions {
      margin-top: 0.75rem;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    button {
      background: var(--accent);
      color: #0f172a;
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.25rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 18px -12px rgba(56, 189, 248, 0.65);
    }

    button.secondary {
      background: rgba(148, 163, 184, 0.15);
      color: #cbd5f5;
    }

    aside {
      position: sticky;
      top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      height: calc(100vh - 3rem);
    }

    .summary-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .summary-card h3 {
      margin-top: 0;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.9rem;
      color: #cbd5f5;
    }

    .summary-grid {
      display: grid;
      gap: 0.5rem;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      align-items: baseline;
      padding: 0.4rem 0.5rem;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.3);
      border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .summary-item span:last-child {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }

    .status-ok {
      background: rgba(52, 211, 153, 0.15);
      color: var(--success);
      border: 1px solid rgba(52, 211, 153, 0.35);
    }

    .status-needs {
      background: rgba(248, 113, 113, 0.15);
      color: var(--danger);
      border: 1px solid rgba(248, 113, 113, 0.35);
    }

    .summary-block-title {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0;
    }

    .summary-block {
      display: grid;
      gap: 0.5rem;
    }

    .platform-breakdown {
      margin-top: 0.75rem;
      border-top: 1px solid rgba(148, 163, 184, 0.12);
      padding-top: 0.75rem;
      display: grid;
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    .platform-breakdown div {
      display: flex;
      justify-content: space-between;
      color: var(--muted);
    }

    .chart-section {
      display: grid;
      gap: 0.75rem;
    }

    .chart-grid {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .chart-card {
      border: 1px solid rgba(148, 163, 184, 0.12);
      border-radius: 12px;
      padding: 0.75rem;
      background: rgba(15, 23, 42, 0.45);
      box-shadow: 0 18px 32px -28px rgba(15, 23, 42, 0.8);
    }

    .chart-card h3 {
      margin: 0 0 0.4rem;
      font-size: 0.85rem;
      color: #cbd5f5;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .chart-wrapper {
      position: relative;
      width: 100%;
      min-height: 150px;
    }

    .paid-media-mode {
      display: flex;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    .paid-media-mode label {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
    }

    .input-group {
      display: grid;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }

    .margin-controls {
      display: grid;
      gap: 0.4rem;
    }

    .margin-inputs {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 0.35rem;
    }

    .margin-inputs input[type="range"] {
      width: 100%;
    }

    .margin-inputs input[type="number"] {
      width: 4rem;
      justify-self: end;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }

    .input-row label {
      font-size: 0.8rem;
      color: var(--muted);
    }

    footer {
      padding: 1rem 2rem;
      text-align: center;
      color: var(--muted);
    }

    .danger-text {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Precise Influencer Calculator</h1>
    <p>Architect and protect the creator campaign economics in one responsive workspace.</p>
  </header>
  <main>
    <div>
      <section id="gating-section">
        <h2>Gating Questions</h2>
        <div class="gating-grid" id="gating-grid"></div>
      </section>

      <section>
        <h2>Build the Campaign</h2>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Platform</th>
                <th>Deliverable</th>
                <th>Creator Vertical</th>
                <th>Creator Language</th>
                <th>Creator Size</th>
                <th>Whitelist</th>
                <th>CPV ($)</th>
                <th>No. Creators</th>
                <th>No. Content Each</th>
                <th>Views per Piece</th>
                <th>Total COGs</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="campaign-body"></tbody>
          </table>
        </div>
        <div class="table-actions">
          <button id="add-line">Add Deliverable</button>
          <button class="secondary" id="reset-state">Reset All</button>
        </div>
      </section>

      <section>
        <h2>Paid Media Options</h2>
        <div class="paid-media-mode">
          <label><input type="radio" name="paid-mode" value="cpv" /> CPV Mode</label>
          <label><input type="radio" name="paid-mode" value="cpm" /> CPM Mode</label>
        </div>
        <div class="input-group">
          <div class="input-row">
            <label for="paid-budget">Paid Media Budget</label>
            <input type="number" id="paid-budget" min="0" step="100" />
          </div>
          <div class="input-row">
            <label id="paid-rate-label" for="paid-rate">CPV</label>
            <input type="number" id="paid-rate" min="0" step="0.001" />
          </div>
        </div>
      </section>

      <section>
        <h2>Travel &amp; Additional Costs</h2>
        <div class="input-group">
          <div class="input-row">
            <label for="other-costs">Other Costs</label>
            <input type="number" id="other-costs" min="0" step="100" />
          </div>
          <div class="input-row">
            <label for="study-costs">Study Costs</label>
            <input type="number" id="study-costs" min="0" step="100" />
          </div>
          <div class="input-row">
            <label for="additional-costs">Additional Costs</label>
            <input type="number" id="additional-costs" min="0" step="100" />
          </div>
        </div>
        <div id="travel-controls" class="input-group" style="display:none; margin-top:0.5rem;">
          <div class="input-row">
            <label for="travel-creators">Traveling Creators</label>
            <input type="number" id="travel-creators" min="0" step="1" />
          </div>
          <div class="input-row">
            <label for="travel-budget">Travel Budget / Creator</label>
            <input type="number" id="travel-budget" min="0" step="100" />
          </div>
        </div>
      </section>

      <section class="chart-section">
        <h2>Campaign Insights</h2>
        <div class="chart-grid">
          <div class="chart-card">
            <h3>Budget Split by Platform</h3>
            <div class="chart-wrapper">
              <canvas id="platform-budget-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Budget Split by Creator Size</h3>
            <div class="chart-wrapper">
              <canvas id="size-budget-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Estimated Views by Platform</h3>
            <div class="chart-wrapper">
              <canvas id="platform-view-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Organic vs Paid Views</h3>
            <div class="chart-wrapper">
              <canvas id="view-mix-chart"></canvas>
            </div>
          </div>
        </div>
      </section>
    </div>
    <aside>
      <div class="summary-card">
        <h3>Estimated Deliverables &amp; Commercials</h3>
        <div class="margin-controls">
          <label for="margin-goal" style="font-size:0.75rem; color:var(--muted);">Margin Goal (%)</label>
          <div class="margin-inputs">
            <input type="range" id="margin-goal-slider" min="0" max="90" step="1" />
            <input type="number" id="margin-goal" min="0" max="90" step="1" />
          </div>
        </div>
        <div id="status-badge" class="status-badge status-ok">OK — Ready</div>
        <div class="summary-block">
          <p class="summary-block-title">Cost Breakdown</p>
          <div class="summary-grid" id="cost-summary"></div>
        </div>
        <div class="summary-block">
          <p class="summary-block-title">Delivery Metrics</p>
          <div class="summary-grid" id="summary-grid"></div>
        </div>
        <div class="platform-breakdown" id="platform-breakdown"></div>
      </div>
    </aside>
  </main>
  <footer>
    State auto-saves locally. Refresh anytime and pick up where you left off.
  </footer>

  <script>
    /* =============================
       Constants (EMPTY tab mapping)
       =============================
       The workbook exposes key multipliers near rows 44563-44613. They are consolidated below for easy edits.
    */
    const STORAGE_KEY = 'precise-influencer-calculator-v1';
    let platformBudgetChart = null;
    let sizeBudgetChart = null;
    let platformViewChart = null;
    let viewMixChart = null;

    const DEFAULT_PAID_RATES = {
      cpv: 0.03,
      cpm: 12,
    };

    const SIZE_MULT = {
      Icon: { rate: 1.636, views: 2.083 },
      Mega: { rate: 1.273, views: 1.458 },
      Macro: { rate: 1, views: 1 },
      HMid: { rate: 0.818, views: 0.45 },
      LMid: { rate: 0.636, views: 0.22 },
      Micro: { rate: 0.5, views: 0.07 },
    };

    const SIZE_FOLLOWERS = {
      Icon: 7500000,
      Mega: 2500000,
      Macro: 750000,
      HMid: 375000,
      LMid: 175000,
      Micro: 55000,
    };

    const VERTICAL_MULT = {
      General: { rate: 1, views: 1 },
      Gaming: { rate: 1.12, views: 1.05 },
      Beauty: { rate: 1.18, views: 1.1 },
      Finance: { rate: 1.25, views: 0.95 },
      Technology: { rate: 1.15, views: 1 },
      Lifestyle: { rate: 1.05, views: 1.08 },
    };

    const LANGUAGE_MULT = {
      English: { rate: 1, views: 1 },
      Spanish: { rate: 0.92, views: 1.08 },
      Portuguese: { rate: 0.88, views: 1.05 },
      French: { rate: 0.95, views: 1.02 },
      German: { rate: 0.97, views: 0.98 },
      Japanese: { rate: 1.05, views: 0.9 },
    };

    const WHITELIST_UPLIFT_PCT = {
      Icon: 0.3,
      Mega: 0.3,
      Macro: 0.3,
      HMid: 0.3,
      LMid: 0.1,
      Micro: 0,
    };

    // Each deliverable stores a base macro view count and creator CPV so we can derive
    // consistent pricing across creator sizes while still allowing vertical/language uplifts.
    const RATE_CARD = {
      YouTube: {
        deliverables: {
          Dedicated: { baseViews: 500000, cpv: 0.09 },
          Integrated: { baseViews: 250000, cpv: 0.128 },
          Shorts: { baseViews: 150000, cpv: 0.12 },
          Stream: { baseViews: 20000, cpv: 2 },
        },
      },
      Instagram: {
        deliverables: {
          Reel: { baseViews: 90000, cpv: 0.133 },
          Video: { baseViews: 80000, cpv: 0.125 },
          Story: { baseViews: 50000, cpv: 0.14 },
          Photo: { baseViews: 39000, cpv: 0.154 },
        },
      },
      TikTok: {
        deliverables: {
          Video: { baseViews: 120000, cpv: 0.125 },
          Live: { baseViews: 60000, cpv: 0.367 },
        },
      },
      Twitch: {
        deliverables: {
          Stream: { baseViews: 15000, cpv: 2.333 },
        },
      },
      Twitter: {
        deliverables: {
          Video: { baseViews: 50000, cpv: 0.16 },
        },
      },
    };

    const GATE_RULES = [
      {
        id: 'listApproved',
        label: 'Will the brand approve a list 4x the views/content pieces required?',
        approver: 'Director',
        default: true,
        effect(value, ctx) {
          if (!value) {
            ctx.contentMultiplier += 0.1; // fallback for list scrubbing overhead
            ctx.approvalsNeeded.add('Director');
          }
        },
      },
      {
        id: 'timelineAdequate',
        label: 'Will the execution team have at least 6 weeks to complete the campaign (list creation, outreach, negotiations, content live, etc.)?',
        approver: 'Director',
        default: true,
        effect(value, ctx) {
          if (!value) {
            ctx.otherMultiplier += 0.1; // rush fee uplift from EMPTY buffer logic
            ctx.organicViewMultiplier -= 0.05; // rushed work underperforms slightly
            ctx.approvalsNeeded.add('Director');
          }
        },
      },
      {
        id: 'withinQ1Q3',
        label: 'Will the campaign happen within Q1 - Q3?',
        approver: null,
        default: true,
        effect(value, ctx) {
          if (!value) {
            ctx.contentMultiplier += 0.15; // Q4 buffer (K61 = 0.15)
          }
        },
      },
      {
        id: 'brandFit',
        label: 'Will the creators want to partner with this brand (i.e. nothing too spammy, sketchy, gambling, sex toys, etc.)?',
        approver: 'Director',
        default: true,
        effect(value, ctx) {
          if (!value) {
            ctx.contentMultiplier += 0.2;
            ctx.organicViewMultiplier -= 0.1; // lower organic reach when brand is risky
            ctx.approvalsNeeded.add('Director');
          }
        },
      },
      {
        id: 'messagingSimple',
        label: 'Will the brand messaging be simple (no more than 3 talking points)?',
        approver: 'Director',
        default: true,
        effect(value, ctx) {
          if (!value) {
            ctx.contentMultiplier += 0.08;
            ctx.approvalsNeeded.add('Director');
          }
        },
      },
      {
        id: 'creatorControl',
        label: 'Will the creators have control of their content and can integrate the brand how they want?',
        approver: 'Director',
        default: true,
        effect(value, ctx) {
          if (!value) {
            ctx.organicViewMultiplier -= 0.08;
            ctx.contentMultiplier += 0.05;
            ctx.approvalsNeeded.add('Director');
          }
        },
      },
      {
        id: 'postingWindow',
        label: 'Will the creators have a posting window of at least a week (i.e. not on a specific launch day, but a day within a week)',
        approver: 'Director',
        default: true,
        effect(value, ctx) {
          if (!value) {
            ctx.otherMultiplier += 0.05;
            ctx.approvalsNeeded.add('Director');
          }
        },
      },
      {
        id: 'creationTime',
        label: 'Will the creators have at least 3 weeks to create their content?',
        approver: 'Director',
        default: true,
        effect(value, ctx) {
          if (!value) {
            ctx.contentMultiplier += 0.05;
            ctx.approvalsNeeded.add('Director');
          }
        },
      },
      {
        id: 'legalClear',
        label: 'Will the content/creator strategy not have any potential legal issues (i.e. giveaways, travel, renting cars, purchasing large gifts, etc.)',
        approver: 'Director',
        default: true,
        effect(value, ctx) {
          if (!value) {
            ctx.otherMultiplier += 0.12; // legal handling uplift
            ctx.approvalsNeeded.add('Director');
          }
        },
      },
      {
        id: 'brandCoverTravel',
        label: 'Will brand cover creator travel (if applicable)? If not, allocate $5k per creator in Travel Budget.',
        approver: null,
        default: true,
        effect(value, ctx) {
          ctx.travelCovered = value;
        },
      },
      {
        id: 'brandExclusivity',
        label: 'Will the brand want brand exclusivity on the creator\'s channel for 3 months?',
        approver: null,
        default: false,
        effect(value, ctx) {
          if (value) {
            ctx.contentMultiplier += 0.2; // Exclusivity Multiplier (K58)
          }
        },
      },
      {
        id: 'travelNeeded',
        label: 'Will the creator need to travel to an event?',
        approver: null,
        default: false,
        effect(value, ctx) {
          ctx.travelRequired = value;
          if (value && !ctx.travelCovered) {
            ctx.otherMultiplier += 0.02; // handling overhead
          }
        },
      },
      {
        id: 'nicheGroup',
        label: 'Will the creators be a niche group (i.e. skinfluencers, bakers in Atlanta, etc.)',
        approver: 'Mark',
        default: false,
        effect(value, ctx) {
          if (value) {
            ctx.contentMultiplier += 0.2; // Niche multiplier (K59)
            ctx.approvalsNeeded.add('Mark');
          }
        },
      },
      {
        id: 'brandLiftStudy',
        label: 'Does the brand want an organic brand lift study?',
        approver: null,
        default: false,
        effect(value, ctx) {
          if (value) {
            ctx.otherBase += 12000; // placeholder for study vendor cost
          }
        },
      },
      {
        id: 'salesStudy',
        label: 'Does the brand want a sales measurement study?',
        approver: null,
        default: false,
        effect(value, ctx) {
          if (value) {
            ctx.otherBase += 15000;
          }
        },
      },
      {
        id: 'awarenessOnly',
        label: 'Will the main KPI for the campaign be just awareness?',
        approver: 'Director',
        default: true,
        effect(value, ctx) {
          if (!value) {
            ctx.contentMultiplier += 0.05; // non-awareness adds extra deliverable pressure
            ctx.approvalsNeeded.add('Director');
          }
        },
      },
    ];

    function createDefaultLine() {
      const platform = Object.keys(RATE_CARD)[0];
      const deliverable = Object.keys(RATE_CARD[platform].deliverables)[0];
      const size = 'Macro';
      const vertical = Object.keys(VERTICAL_MULT)[0];
      const language = Object.keys(LANGUAGE_MULT)[0];
      const defaults = getRateDefaults(platform, deliverable, size, vertical, language);
      return {
        platform,
        deliverable,
        vertical,
        language,
        size,
        whitelist: false,
        unitRate: defaults.cpv,
        qtyPerCreator: 0,
        creators: 0,
        viewsPerPiece: defaults.views,
        manualViews: false,
      };
    }

    function applyLineDefaults(line, options = {}) {
      const { forceViews = false } = options;
      const defaults = getRateDefaults(line.platform, line.deliverable, line.size, line.vertical, line.language);
      line.unitRate = defaults.cpv;
      if (forceViews || !line.manualViews) {
        line.viewsPerPiece = defaults.views;
      }
      return line;
    }

    function getRateDefaults(platform, deliverable, size, vertical, language) {
      const base = RATE_CARD[platform]?.deliverables?.[deliverable] || { baseViews: 0, cpv: 0 };
      const sizeAdjust = SIZE_MULT[size] || { rate: 1, views: 1 };
      const verticalAdjust = VERTICAL_MULT[vertical] || { rate: 1, views: 1 };
      const languageAdjust = LANGUAGE_MULT[language] || { rate: 1, views: 1 };
      const views = Math.round(
        (base.baseViews || 0)
          * (sizeAdjust.views ?? 1)
          * (verticalAdjust.views ?? 1)
          * (languageAdjust.views ?? 1),
      );
      const cpvRaw = (base.cpv || 0)
        * (sizeAdjust.rate ?? 1)
        * (verticalAdjust.rate ?? 1)
        * (languageAdjust.rate ?? 1);
      return {
        cpv: Number.isFinite(cpvRaw) ? Number(cpvRaw.toFixed(3)) : 0,
        views,
      };
    }

    const defaultState = {
      gating: Object.fromEntries(GATE_RULES.map(rule => [rule.id, rule.default])),
      otherCosts: {
        other: 0,
        study: 0,
        additional: 0,
      },
      travel: {
        creators: 0,
        perCreator: 0,
      },
      campaignLines: [createDefaultLine()],
      paidMedia: {
        mode: 'cpv',
        budget: 0,
        rate: DEFAULT_PAID_RATES.cpv,
      },
      marginGoal: 0,
    };

    let state = loadState();

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        const mergedPaidMedia = { ...defaultState.paidMedia, ...parsed.paidMedia };
        if (!mergedPaidMedia.rate || mergedPaidMedia.rate <= 0) {
          mergedPaidMedia.rate = DEFAULT_PAID_RATES[mergedPaidMedia.mode] ?? DEFAULT_PAID_RATES.cpv;
        }
        return {
          ...structuredClone(defaultState),
          ...parsed,
          gating: { ...defaultState.gating, ...parsed.gating },
          otherCosts: { ...defaultState.otherCosts, ...parsed.otherCosts },
          travel: { ...defaultState.travel, ...parsed.travel },
          campaignLines: (parsed.campaignLines || []).map(line => {
            const merged = { ...createDefaultLine(), ...line };
            merged.manualViews = false;
            return applyLineDefaults(merged, { forceViews: true });
          }),
          paidMedia: mergedPaidMedia,
        };
      } catch (err) {
        console.error('Failed to load state', err);
        return structuredClone(defaultState);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function init() {
      renderGating();
      renderCampaign();
      bindPaidMedia();
      bindOtherCosts();
      bindSummaryControls();
      recalc();
    }

    function renderGating() {
      const grid = document.getElementById('gating-grid');
      grid.innerHTML = '';
      GATE_RULES.forEach(rule => {
        const row = document.createElement('div');
        row.className = 'gating-item';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!state.gating[rule.id];
        checkbox.id = rule.id;
        checkbox.addEventListener('change', () => {
          state.gating[rule.id] = checkbox.checked;
          saveState();
          recalc();
          if (rule.id === 'travelNeeded' || rule.id === 'brandCoverTravel') {
            toggleTravelControls();
          }
        });
        const label = document.createElement('label');
        label.htmlFor = rule.id;
        label.textContent = rule.label;
        if (rule.approver) {
          const tag = document.createElement('div');
          tag.className = 'approver-tag';
          tag.textContent = `Approver: ${rule.approver}`;
          label.appendChild(document.createElement('br'));
          label.appendChild(tag);
        }
        row.appendChild(checkbox);
        row.appendChild(label);
        grid.appendChild(row);
      });
      toggleTravelControls();
    }

    function toggleTravelControls() {
      const travelBlock = document.getElementById('travel-controls');
      if (state.gating.travelNeeded) {
        travelBlock.style.display = 'grid';
      } else {
        travelBlock.style.display = 'none';
      }
    }

    function renderCampaign() {
      const tbody = document.getElementById('campaign-body');
      tbody.innerHTML = '';
      state.campaignLines.forEach((line, index) => {
        const tr = document.createElement('tr');

        if (!line.vertical) line.vertical = Object.keys(VERTICAL_MULT)[0];
        if (!line.language) line.language = Object.keys(LANGUAGE_MULT)[0];
        line.manualViews = false;
        applyLineDefaults(line, { forceViews: true });

        const platformTd = document.createElement('td');
        const platformSelect = document.createElement('select');
        Object.keys(RATE_CARD).forEach(platform => {
          const opt = document.createElement('option');
          opt.value = platform;
          opt.textContent = platform;
          if (platform === line.platform) opt.selected = true;
          platformSelect.appendChild(opt);
        });
        platformSelect.addEventListener('change', () => {
          line.platform = platformSelect.value;
          const deliverables = Object.keys(RATE_CARD[line.platform].deliverables);
          if (!deliverables.includes(line.deliverable)) {
            line.deliverable = deliverables[0];
          }
          line.manualViews = false;
          applyLineDefaults(line, { forceViews: true });
          renderCampaign();
          saveState();
          recalc();
        });
        platformTd.appendChild(platformSelect);
        tr.appendChild(platformTd);

        const deliverableTd = document.createElement('td');
        const deliverableSelect = document.createElement('select');
        const deliverableOptions = RATE_CARD[line.platform]?.deliverables || {};
        Object.keys(deliverableOptions).forEach(deliverable => {
          const opt = document.createElement('option');
          opt.value = deliverable;
          opt.textContent = deliverable;
          if (deliverable === line.deliverable) opt.selected = true;
          deliverableSelect.appendChild(opt);
        });
        deliverableSelect.addEventListener('change', () => {
          line.deliverable = deliverableSelect.value;
          line.manualViews = false;
          applyLineDefaults(line, { forceViews: true });
          renderCampaign();
          saveState();
          recalc();
        });
        deliverableTd.appendChild(deliverableSelect);
        tr.appendChild(deliverableTd);

        const verticalTd = document.createElement('td');
        const verticalSelect = document.createElement('select');
        Object.keys(VERTICAL_MULT).forEach(vertical => {
          const opt = document.createElement('option');
          opt.value = vertical;
          opt.textContent = vertical;
          if (vertical === line.vertical) opt.selected = true;
          verticalSelect.appendChild(opt);
        });
        verticalSelect.addEventListener('change', () => {
          line.vertical = verticalSelect.value;
          line.manualViews = false;
          applyLineDefaults(line, { forceViews: true });
          renderCampaign();
          saveState();
          recalc();
        });
        verticalTd.appendChild(verticalSelect);
        tr.appendChild(verticalTd);

        const languageTd = document.createElement('td');
        const languageSelect = document.createElement('select');
        Object.keys(LANGUAGE_MULT).forEach(language => {
          const opt = document.createElement('option');
          opt.value = language;
          opt.textContent = language;
          if (language === line.language) opt.selected = true;
          languageSelect.appendChild(opt);
        });
        languageSelect.addEventListener('change', () => {
          line.language = languageSelect.value;
          line.manualViews = false;
          applyLineDefaults(line, { forceViews: true });
          renderCampaign();
          saveState();
          recalc();
        });
        languageTd.appendChild(languageSelect);
        tr.appendChild(languageTd);

        const sizeTd = document.createElement('td');
        const sizeSelect = document.createElement('select');
        Object.keys(SIZE_MULT).forEach(size => {
          const opt = document.createElement('option');
          opt.value = size;
          opt.textContent = size;
          if (size === line.size) opt.selected = true;
          sizeSelect.appendChild(opt);
        });
        sizeSelect.addEventListener('change', () => {
          line.size = sizeSelect.value;
          line.manualViews = false;
          applyLineDefaults(line, { forceViews: true });
          renderCampaign();
          saveState();
          recalc();
        });
        sizeTd.appendChild(sizeSelect);
        tr.appendChild(sizeTd);

        const whitelistTd = document.createElement('td');
        const whitelistCheckbox = document.createElement('input');
        whitelistCheckbox.type = 'checkbox';
        whitelistCheckbox.checked = line.whitelist;
        whitelistCheckbox.addEventListener('change', () => {
          line.whitelist = whitelistCheckbox.checked;
          saveState();
          recalc();
        });
        whitelistTd.appendChild(whitelistCheckbox);
        tr.appendChild(whitelistTd);

        const unitRateTd = document.createElement('td');
        const unitRateInput = document.createElement('input');
        unitRateInput.type = 'number';
        unitRateInput.min = '0';
        unitRateInput.step = '0.001';
        const cpvValue = Number(line.unitRate || 0);
        unitRateInput.value = Number.isFinite(cpvValue) ? cpvValue.toFixed(3) : '0.000';
        unitRateInput.disabled = true;
        unitRateTd.appendChild(unitRateInput);
        tr.appendChild(unitRateTd);

        const creatorsTd = document.createElement('td');
        const creatorsInput = document.createElement('input');
        creatorsInput.type = 'number';
        creatorsInput.min = '0';
        creatorsInput.step = '1';
        creatorsInput.value = Number(line.creators || 0);
        creatorsInput.addEventListener('change', () => {
          line.creators = parseFloat(creatorsInput.value) || 0;
          saveState();
          recalc();
        });
        creatorsTd.appendChild(creatorsInput);
        tr.appendChild(creatorsTd);

        const contentTd = document.createElement('td');
        const contentInput = document.createElement('input');
        contentInput.type = 'number';
        contentInput.min = '0';
        contentInput.step = '1';
        contentInput.value = Number(line.qtyPerCreator || 0);
        contentInput.addEventListener('change', () => {
          line.qtyPerCreator = parseFloat(contentInput.value) || 0;
          saveState();
          recalc();
        });
        contentTd.appendChild(contentInput);
        tr.appendChild(contentTd);

        const viewsTd = document.createElement('td');
        const viewsDisplay = document.createElement('div');
        viewsDisplay.className = 'readonly-value';
        viewsDisplay.textContent = formatNumber(line.viewsPerPiece || 0);
        viewsTd.appendChild(viewsDisplay);
        tr.appendChild(viewsTd);

        const lineTotalTd = document.createElement('td');
        lineTotalTd.textContent = formatCurrency(calculateLineTotal(line));
        tr.appendChild(lineTotalTd);

        const deleteTd = document.createElement('td');
        if (state.campaignLines.length > 1) {
          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'Remove';
          removeBtn.className = 'secondary';
          removeBtn.addEventListener('click', () => {
            state.campaignLines.splice(index, 1);
            saveState();
            renderCampaign();
            recalc();
          });
          deleteTd.appendChild(removeBtn);
        }
        tr.appendChild(deleteTd);

        tbody.appendChild(tr);
      });

      document.getElementById('add-line').onclick = () => {
        state.campaignLines.push(createDefaultLine());
        saveState();
        renderCampaign();
        recalc();
      };

      document.getElementById('reset-state').onclick = () => {
        if (confirm('Reset calculator to defaults?')) {
          state = structuredClone(defaultState);
          saveState();
          renderGating();
          renderCampaign();
          bindPaidMedia();
          bindOtherCosts();
          bindSummaryControls();
          recalc();
        }
      };
    }

    function calculateLineTotal(line) {
      applyLineDefaults(line);
      const cpv = line.unitRate || 0;
      const viewsPerPiece = line.viewsPerPiece || 0;
      const perCreatorBase = cpv * viewsPerPiece * (line.qtyPerCreator || 0);
      // Mirrors EMPTY workbook calc: base rate * qty * whitelist multiplier
      const whitelistMultiplier = line.whitelist
        ? 1 + (WHITELIST_UPLIFT_PCT[line.size] ?? 0.2)
        : 1;
      const cogsPerCreator = perCreatorBase * whitelistMultiplier;
      line.cogsPerCreator = cogsPerCreator;
      return cogsPerCreator * (line.creators || 0);
    }

    function bindPaidMedia() {
      const modeInputs = document.querySelectorAll('input[name="paid-mode"]');
      const budgetInput = document.getElementById('paid-budget');
      const rateInput = document.getElementById('paid-rate');

      if (!state.paidMedia.rate || state.paidMedia.rate <= 0) {
        state.paidMedia.rate = DEFAULT_PAID_RATES[state.paidMedia.mode] ?? DEFAULT_PAID_RATES.cpv;
      }

      modeInputs.forEach(input => {
        input.checked = state.paidMedia.mode === input.value;
        input.addEventListener('change', () => {
          if (input.checked) {
            const previousMode = state.paidMedia.mode;
            const previousRate = state.paidMedia.rate;
            state.paidMedia.mode = input.value;
            if (!previousRate || previousRate === (DEFAULT_PAID_RATES[previousMode] ?? DEFAULT_PAID_RATES.cpv)) {
              state.paidMedia.rate = DEFAULT_PAID_RATES[state.paidMedia.mode] ?? DEFAULT_PAID_RATES.cpv;
            }
            rateInput.value = Number(state.paidMedia.rate || 0);
            saveState();
            updatePaidRateLabel();
            recalc();
          }
        });
      });

      budgetInput.value = Number(state.paidMedia.budget || 0);
      budgetInput.addEventListener('change', () => {
        state.paidMedia.budget = parseFloat(budgetInput.value) || 0;
        saveState();
        recalc();
      });

      rateInput.value = Number(state.paidMedia.rate || 0);
      rateInput.addEventListener('change', () => {
        state.paidMedia.rate = parseFloat(rateInput.value) || 0;
        saveState();
        recalc();
      });

      updatePaidRateLabel();
    }

    function updatePaidRateLabel() {
      const label = document.getElementById('paid-rate-label');
      const isCpm = state.paidMedia.mode === 'cpm';
      label.textContent = isCpm ? 'CPM' : 'CPV';
      const rateInput = document.getElementById('paid-rate');
      rateInput.step = isCpm ? '0.1' : '0.001';
      rateInput.placeholder = (DEFAULT_PAID_RATES[state.paidMedia.mode] ?? DEFAULT_PAID_RATES.cpv).toString();
    }

    function bindOtherCosts() {
      const otherInput = document.getElementById('other-costs');
      const studyInput = document.getElementById('study-costs');
      const additionalInput = document.getElementById('additional-costs');
      const travelCreators = document.getElementById('travel-creators');
      const travelBudget = document.getElementById('travel-budget');

      otherInput.value = Number(state.otherCosts.other || 0);
      studyInput.value = Number(state.otherCosts.study || 0);
      additionalInput.value = Number(state.otherCosts.additional || 0);
      travelCreators.value = Number(state.travel.creators || 0);
      travelBudget.value = Number(state.travel.perCreator || 0);

      otherInput.addEventListener('change', () => {
        state.otherCosts.other = parseFloat(otherInput.value) || 0;
        saveState();
        recalc();
      });
      studyInput.addEventListener('change', () => {
        state.otherCosts.study = parseFloat(studyInput.value) || 0;
        saveState();
        recalc();
      });
      additionalInput.addEventListener('change', () => {
        state.otherCosts.additional = parseFloat(additionalInput.value) || 0;
        saveState();
        recalc();
      });
      travelCreators.addEventListener('change', () => {
        state.travel.creators = parseFloat(travelCreators.value) || 0;
        saveState();
        recalc();
      });
      travelBudget.addEventListener('change', () => {
        state.travel.perCreator = parseFloat(travelBudget.value) || 0;
        saveState();
        recalc();
      });
    }

    function bindSummaryControls() {
      const marginInput = document.getElementById('margin-goal');
      const marginSlider = document.getElementById('margin-goal-slider');
      const currentMargin = Number(state.marginGoal || 0);
      if (marginInput) {
        marginInput.value = currentMargin;
      }
      if (marginSlider) {
        marginSlider.value = currentMargin;
      }

      function updateMargin(value) {
        const sanitized = Math.min(90, Math.max(0, Number(value) || 0));
        state.marginGoal = sanitized;
        if (marginInput) {
          marginInput.value = sanitized;
        }
        if (marginSlider) {
          marginSlider.value = sanitized;
        }
        recalc();
      }

      marginInput?.addEventListener('change', () => {
        updateMargin(marginInput.value);
      });

      marginSlider?.addEventListener('input', () => {
        updateMargin(marginSlider.value);
      });
    }

    function applyGating() {
      const ctx = {
        contentMultiplier: 1,
        otherMultiplier: 1,
        organicViewMultiplier: 1,
        travelRequired: false,
        travelCovered: state.gating.brandCoverTravel,
        otherBase: 0,
        approvalsNeeded: new Set(),
      };
      GATE_RULES.forEach(rule => {
        const value = !!state.gating[rule.id];
        if (typeof rule.effect === 'function') {
          rule.effect(value, ctx);
        }
      });
      // clamp organic multiplier (cannot drop below 0.4 of forecast)
      ctx.organicViewMultiplier = Math.max(0.4, ctx.organicViewMultiplier);
      return ctx;
    }

    function recalc() {
      const gating = applyGating();
      const contentLines = state.campaignLines.map(line => ({
        ...line,
        total: calculateLineTotal(line),
        cogsPerCreator: line.cogsPerCreator || 0,
      }));
      const platformBudget = {};
      const sizeBudget = {};
      contentLines.forEach(line => {
        const lineTotal = line.total || 0;
        if (lineTotal > 0) {
          const adjusted = lineTotal * gating.contentMultiplier;
          platformBudget[line.platform] = (platformBudget[line.platform] || 0) + adjusted;
          sizeBudget[line.size] = (sizeBudget[line.size] || 0) + adjusted;
        }
      });
      const contentSubtotal = contentLines.reduce((acc, line) => acc + line.total, 0);
      const organicViewsRaw = state.campaignLines.reduce((acc, line) => {
        const lineViews = (line.viewsPerPiece || 0) * (line.qtyPerCreator || 0) * (line.creators || 0);
        return acc + lineViews;
      }, 0);
      const organicViewsAdjusted = organicViewsRaw * gating.organicViewMultiplier;

      const platformViews = {};
      let totalEstimatedFollowers = 0;
      state.campaignLines.forEach(line => {
        const lineViews = (line.viewsPerPiece || 0) * (line.qtyPerCreator || 0) * (line.creators || 0) * gating.organicViewMultiplier;
        if (!platformViews[line.platform]) platformViews[line.platform] = 0;
        platformViews[line.platform] += lineViews;
        const avgFollowers = SIZE_FOLLOWERS[line.size] || 0;
        totalEstimatedFollowers += avgFollowers * (line.creators || 0);
      });

      const gatingAdjustedContent = contentSubtotal * gating.contentMultiplier;
      const otherBase = (state.otherCosts.other || 0) + (state.otherCosts.study || 0) + (state.otherCosts.additional || 0) + gating.otherBase;
      const otherTotal = otherBase * gating.otherMultiplier;
      const travelCost = gating.travelRequired && !gating.travelCovered
        ? (state.travel.creators || 0) * (state.travel.perCreator || 0)
        : 0;

      const paidBudget = state.paidMedia.budget || 0;
      const paidViews = calculatePaidViews();
      const totalCOGs = gatingAdjustedContent + otherTotal + travelCost + paidBudget;
      const marginGoalPct = (state.marginGoal || 0) / 100;
      const totalPrice = marginGoalPct >= 1 ? totalCOGs : totalCOGs / (1 - marginGoalPct);
      const grossMargin = totalPrice - totalCOGs;
      const totalContentPieces = state.campaignLines.reduce((acc, line) => acc + (line.qtyPerCreator || 0) * (line.creators || 0), 0);
      const totalCreators = state.campaignLines.reduce((acc, line) => acc + (line.creators || 0), 0);
      const totalCogsPerCreator = totalCreators > 0 ? totalCOGs / totalCreators : 0;
      const pricePerCreator = totalCreators > 0 ? totalPrice / totalCreators : 0;
      const totalViews = organicViewsAdjusted + paidViews;
      const brandCPM = totalViews > 0 ? (totalPrice / totalViews) * 1000 : 0;
      const adRateCpv = organicViewsAdjusted > 0 ? gatingAdjustedContent / organicViewsAdjusted : 0;

      updateSummary({
        contentSubtotal,
        gatingAdjustedContent,
        organicViewsRaw,
        organicViewsAdjusted,
        otherTotal,
        travelCost,
        paidBudget,
        paidViews,
        totalCOGs,
        totalPrice,
        grossMargin,
        totalContentPieces,
        totalCreators,
        totalCogsPerCreator,
        pricePerCreator,
        brandCPM,
        totalViews,
        platformViews,
        totalEstimatedFollowers,
        adRateCpv,
        approvalsNeeded: gating.approvalsNeeded,
      });

      const viewMix = {
        'Organic Views': organicViewsAdjusted,
        'Paid Views': paidViews,
      };

      updateCharts(platformBudget, sizeBudget, platformViews, viewMix);
      updateLineTotals(contentLines);
      saveState();
    }

    function calculatePaidViews() {
      const { mode, budget, rate } = state.paidMedia;
      if (!rate || rate <= 0) return 0;
      if (mode === 'cpm') {
        return (budget || 0) / rate * 1000;
      }
      return (budget || 0) / rate;
    }

    function updateSummary(data) {
      const costGrid = document.getElementById('cost-summary');
      const metricsGrid = document.getElementById('summary-grid');

      if (costGrid) {
        costGrid.innerHTML = '';
        const costItems = [
          ['Content / Influencer COGs', formatCurrency(data.gatingAdjustedContent)],
          ['Paid Media Budget', formatCurrency(data.paidBudget)],
          ['Other COGs', formatCurrency(data.otherTotal)],
          ['Travel COGs', formatCurrency(data.travelCost)],
          ['Total COGs', formatCurrency(data.totalCOGs)],
          ['Total Price', formatCurrency(data.totalPrice)],
          ['Gross Margin', formatCurrency(data.grossMargin)],
        ];
        appendSummaryRows(costGrid, costItems);
      }

      if (metricsGrid) {
        metricsGrid.innerHTML = '';
        const metricItems = [
          ['Total Content Pieces', data.totalContentPieces],
          ['Total Creators', data.totalCreators],
          ['Total Estimated Views', data.totalViews],
          ['Organic Views (adj.)', data.organicViewsAdjusted],
          ['Paid Views', data.paidViews],
          ['Estimated Followers', data.totalEstimatedFollowers],
          ['Total COGs / Creator', formatCurrency(data.totalCogsPerCreator)],
          ['Price / Creator', formatCurrency(data.pricePerCreator)],
          ['Ad Rate (CPV)', formatCpv(data.adRateCpv)],
          ['Brand CPM', isFinite(data.brandCPM) ? `$${data.brandCPM.toFixed(2)}` : '$0.00'],
        ];
        appendSummaryRows(metricsGrid, metricItems);
      }

      const status = document.getElementById('status-badge');
      if (data.approvalsNeeded.size > 0) {
        status.className = 'status-badge status-needs';
        status.textContent = `Needs ${Array.from(data.approvalsNeeded).join(' & ')} Sign-off`;
      } else {
        status.className = 'status-badge status-ok';
        status.textContent = 'OK — Ready';
      }

      const breakdown = document.getElementById('platform-breakdown');
      breakdown.innerHTML = '<strong style="color:#cbd5f5; font-size:0.85rem;">Platform View Share</strong>';
      const total = Object.values(data.platformViews).reduce((acc, v) => acc + v, 0) || 1;
      Object.entries(data.platformViews).forEach(([platform, views]) => {
        const row = document.createElement('div');
        const pct = ((views / total) * 100).toFixed(1);
        row.innerHTML = `<span>${platform}</span><span>${formatNumber(views)} (${pct}%)</span>`;
        breakdown.appendChild(row);
      });
    }

    function appendSummaryRows(container, items) {
      items.forEach(([label, value]) => {
        const row = document.createElement('div');
        row.className = 'summary-item';
        const labelSpan = document.createElement('span');
        labelSpan.textContent = label;
        const valueSpan = document.createElement('span');
        if (typeof value === 'number' && !label.toLowerCase().includes('cpm')) {
          valueSpan.textContent = formatNumber(value);
        } else {
          valueSpan.textContent = value;
        }
        row.appendChild(labelSpan);
        row.appendChild(valueSpan);
        container.appendChild(row);
      });
    }

    function updateCharts(platformBudget, sizeBudget, platformViews, viewMix) {
      const platformCtx = document.getElementById('platform-budget-chart')?.getContext('2d');
      const sizeCtx = document.getElementById('size-budget-chart')?.getContext('2d');
      const viewPlatformCtx = document.getElementById('platform-view-chart')?.getContext('2d');
      const viewMixCtx = document.getElementById('view-mix-chart')?.getContext('2d');

      const platformData = prepareChartData(platformBudget);
      const sizeData = prepareChartData(sizeBudget);
      const platformViewData = prepareChartData(platformViews, { decimals: 0 });
      const viewMixData = prepareChartData(viewMix, { decimals: 0 });

      platformBudgetChart = renderPieChart(platformBudgetChart, platformCtx, platformData);
      sizeBudgetChart = renderPieChart(sizeBudgetChart, sizeCtx, sizeData);
      platformViewChart = renderPieChart(platformViewChart, viewPlatformCtx, platformViewData, {
        tooltipLabelFormatter: createViewTooltipFormatter('views'),
      });
      viewMixChart = renderPieChart(viewMixChart, viewMixCtx, viewMixData, {
        tooltipLabelFormatter: createViewTooltipFormatter('views'),
      });
    }

    function prepareChartData(source, options = {}) {
      const { decimals = 2 } = options;
      const entries = Object.entries(source || {}).filter(([, value]) => value > 0);
      if (!entries.length) {
        return { labels: ['No Data'], values: [1] };
      }
      entries.sort((a, b) => b[1] - a[1]);
      const labels = entries.map(([label]) => label);
      const values = entries.map(([, value]) => Number(value.toFixed(decimals)));
      return { labels, values };
    }

    function renderPieChart(instance, ctx, data, options = {}) {
      if (!ctx) return instance;
      const palette = ['#38bdf8', '#818cf8', '#f472b6', '#facc15', '#34d399', '#fb7185', '#fbbf24', '#a855f7'];
      const backgroundColor = data.labels.map((_, idx) => palette[idx % palette.length]);
      const dataset = {
        data: data.values,
        backgroundColor,
        borderColor: '#0f172a',
        borderWidth: 2,
      };
      const tooltipLabelFormatter = options.tooltipLabelFormatter || defaultCurrencyTooltipFormatter;
      if (instance) {
        instance.data.labels = data.labels;
        instance.data.datasets[0].data = data.values;
        instance.data.datasets[0].backgroundColor = backgroundColor;
        instance.update();
        return instance;
      }
      return new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.labels,
          datasets: [dataset],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#cbd5f5',
              },
            },
            tooltip: {
              callbacks: {
                label(context) {
                  if (context.label === 'No Data') {
                    return 'No Data';
                  }
                  const value = context.raw || 0;
                  const total = data.values.reduce((acc, v) => acc + v, 0) || 1;
                  return tooltipLabelFormatter(context.label, value, total);
                },
              },
            },
          },
        },
      });
    }

    function defaultCurrencyTooltipFormatter(label, value, total) {
      const pct = ((value / total) * 100).toFixed(1);
      return `${label}: $${formatNumber(value)} (${pct}%)`;
    }

    function createViewTooltipFormatter(unit) {
      return (label, value, total) => {
        const pct = ((value / total) * 100).toFixed(1);
        return `${label}: ${formatNumber(value)} ${unit} (${pct}%)`;
      };
    }

    function updateLineTotals(contentLines) {
      const rows = document.querySelectorAll('#campaign-body tr');
      contentLines.forEach((line, idx) => {
        const row = rows[idx];
        if (!row) return;
        const viewsCell = row.children?.[9];
        const viewDisplay = viewsCell?.querySelector('.readonly-value');
        if (viewDisplay) {
          viewDisplay.textContent = formatNumber(line.viewsPerPiece || 0);
        }
        const totalCell = row.children?.[10];
        if (totalCell) {
          totalCell.textContent = formatCurrency(line.total);
        }
      });
    }

    function formatCurrency(value) {
      return `$${formatNumber(value)}`;
    }

    function formatCpv(value) {
      if (!isFinite(value) || value <= 0) return '$0.000';
      return `$${value.toFixed(3)}`;
    }

    function formatNumber(value) {
      if (!isFinite(value)) return '0';
      return Number(value).toLocaleString('en-US', { maximumFractionDigits: 0 });
    }

    document.addEventListener('DOMContentLoaded', init);

    // placeholder for future EMPTY workbook parsing hook
    function parseEmptyDump(text) {
      console.log('Parser placeholder for EMPTY tab dump', text);
    }
  </script>
</body>
</html>
