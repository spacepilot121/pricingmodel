<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>P.I.C — Precise. Influencer. Calculator.</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f172a;
      --panel: #1e293b;
      --accent: #38bdf8;
      --muted: #94a3b8;
      --danger: #f87171;
      --success: #34d399;
      --warning: #facc15;
      --border: #334155;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html {
      font-size: 0.85rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #e2e8f0;
      line-height: 1.35;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      font-size: 0.85rem;
    }

    header {
      padding: 1.5rem 2rem;
      background: linear-gradient(120deg, rgba(56, 189, 248, 0.25), rgba(99, 102, 241, 0.25));
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }

    header h1 {
      margin: 0 0 0.25rem;
      font-size: 1.85rem;
      letter-spacing: 0.04em;
    }

    header p {
      margin: 0;
      color: var(--muted);
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1fr) 360px;
      gap: 1.1rem;
      padding: 1.1rem;
      font-size: 0.85rem;
    }

    @media (max-width: 1200px) {
      main {
        grid-template-columns: 1fr;
      }

      aside {
        position: static;
        top: auto;
        height: auto;
      }
    }

    section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 24px 48px -32px rgba(15, 23, 42, 0.8);
    }

    section h2 {
      margin-top: 0;
      margin-bottom: 0.65rem;
      font-size: 1rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #cbd5f5;
    }

    #campaign-details h2 {
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
    }

    .details-grid {
      display: grid;
      gap: 0.65rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .details-field {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      padding: 0.65rem 0.75rem;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.12);
      background: rgba(15, 23, 42, 0.35);
    }

    .details-label {
      font-size: 0.75rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .details-field input[type="text"],
    .details-field input[type="range"] {
      width: 100%;
    }

    .details-slider-value {
      font-size: 0.8rem;
      font-weight: 600;
      color: #e2e8f0;
    }

    .details-checkbox {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.65rem 0.75rem;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.12);
      background: rgba(15, 23, 42, 0.35);
      font-size: 0.8rem;
      cursor: pointer;
    }

    .details-checkbox span {
      flex: 1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead th {
      text-align: left;
      padding: 0.4rem;
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.06em;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    tbody td {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.08);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    select,
    input[type="number"],
    input[type="text"] {
      width: 100%;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 6px;
      color: inherit;
      padding: 0.35rem 0.4rem;
      font-size: 0.8rem;
    }

    .readonly-value {
      padding: 0.25rem 0;
      border-radius: 0;
      border: none;
      background: transparent;
      font-size: 0.8rem;
      font-variant-numeric: tabular-nums;
    }

    input[type="checkbox"] {
      accent-color: var(--accent);
      width: 1.1rem;
      height: 1.1rem;
      cursor: pointer;
    }

    .table-actions {
      margin-top: 0.75rem;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .section-pair {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .section-pair > section {
      margin-bottom: 0;
    }

    button {
      background: var(--accent);
      color: #0f172a;
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.25rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 18px -12px rgba(56, 189, 248, 0.65);
    }

    button.secondary {
      background: rgba(148, 163, 184, 0.15);
      color: #cbd5f5;
    }

    button.danger {
      background: rgba(248, 113, 113, 0.18);
      color: var(--danger);
    }

    button.danger:hover {
      box-shadow: 0 12px 18px -12px rgba(248, 113, 113, 0.65);
    }

    body.unauthenticated main,
    body.unauthenticated header,
    body.unauthenticated footer {
      display: none;
    }

    body.unauthenticated #campaign-app {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .auth-container {
      width: min(420px, 100%);
    }

    .auth-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.75rem;
      box-shadow: 0 24px 48px -32px rgba(15, 23, 42, 0.8);
      display: grid;
      gap: 1.25rem;
    }

    .auth-card h2 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.04em;
    }

    .auth-card p {
      margin: 0;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .auth-form {
      display: grid;
      gap: 0.75rem;
    }

    .auth-form label {
      display: grid;
      gap: 0.35rem;
      font-size: 0.85rem;
    }

    .auth-form input[type="email"],
    .auth-form input[type="password"] {
      width: 100%;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 8px;
      color: inherit;
      padding: 0.5rem 0.6rem;
      font-size: 0.85rem;
    }

    .auth-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .auth-error {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 0.35rem;
    }

    .auth-switch {
      background: transparent;
      border: none;
      color: var(--accent);
      cursor: pointer;
      padding: 0;
      font-weight: 600;
    }

    .auth-meta {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
    }

    .auth-loading {
      text-align: center;
      color: var(--muted);
      font-size: 0.9rem;
      padding: 2rem 0;
    }

    .pricing-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.82);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      z-index: 999;
    }

    .pricing-menu {
      width: min(900px, 100%);
      max-height: 90vh;
      overflow-y: auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 1.5rem;
      display: grid;
      gap: 1rem;
      box-shadow: 0 32px 64px -40px rgba(15, 23, 42, 0.9);
    }

    .pricing-menu header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      padding: 0;
      background: transparent;
      border: none;
    }

    .pricing-menu h3 {
      margin: 0;
      font-size: 1.2rem;
    }

    .pricing-section {
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 12px;
      padding: 1rem;
      display: grid;
      gap: 0.75rem;
      background: rgba(15, 23, 42, 0.4);
    }

    .pricing-section h4 {
      margin: 0;
      font-size: 0.95rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #cbd5f5;
    }

    .pricing-grid {
      display: grid;
      gap: 0.5rem;
    }

    .pricing-row {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .pricing-row span:last-child {
      color: #e2e8f0;
      font-weight: 600;
    }

    .pricing-note {
      font-size: 0.75rem;
      color: var(--muted);
    }

    aside {
      position: sticky;
      top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      height: calc(100vh - 3rem);
    }

    .summary-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .summary-card h3 {
      margin-top: 0;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.9rem;
      color: #cbd5f5;
    }

    .summary-grid {
      display: grid;
      gap: 0.5rem;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      align-items: baseline;
      padding: 0.4rem 0.5rem;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.3);
      border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .summary-item span:last-child {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }

    .status-ok {
      background: rgba(52, 211, 153, 0.15);
      color: var(--success);
      border: 1px solid rgba(52, 211, 153, 0.35);
    }

    .status-needs {
      background: rgba(248, 113, 113, 0.15);
      color: var(--danger);
      border: 1px solid rgba(248, 113, 113, 0.35);
    }

    .summary-block-title {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0;
    }

    .summary-block {
      display: grid;
      gap: 0.5rem;
    }

    .budget-status-card {
      border-radius: 12px;
      padding: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(148, 163, 184, 0.08);
      display: grid;
      gap: 0.35rem;
      transition: background 0.2s ease, border-color 0.2s ease;
    }

    .budget-status-title {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 600;
    }

    .budget-status-value {
      font-size: 0.95rem;
      font-weight: 700;
      color: #e2e8f0;
    }

    .budget-status-subtext {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .budget-status-good {
      border-color: rgba(52, 211, 153, 0.4);
      background: rgba(52, 211, 153, 0.12);
      color: var(--success);
    }

    .budget-status-over {
      border-color: rgba(248, 113, 113, 0.4);
      background: rgba(248, 113, 113, 0.12);
      color: var(--danger);
    }

    .budget-status-under {
      border-color: rgba(250, 204, 21, 0.4);
      background: rgba(250, 204, 21, 0.12);
      color: var(--warning);
    }

    .budget-status-neutral {
      color: #cbd5f5;
    }

    .platform-breakdown {
      margin-top: 0.75rem;
      border-top: 1px solid rgba(148, 163, 184, 0.12);
      padding-top: 0.75rem;
      display: grid;
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    .platform-breakdown div {
      display: flex;
      justify-content: space-between;
      color: var(--muted);
    }

    .chart-section {
      display: grid;
      gap: 0.75rem;
    }

    .chart-grid {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }

    @media (min-width: 640px) {
      .chart-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (min-width: 960px) {
      .chart-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (min-width: 1280px) {
      .chart-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    .chart-card {
      border: 1px solid rgba(148, 163, 184, 0.12);
      border-radius: 12px;
      padding: 0.75rem;
      background: rgba(15, 23, 42, 0.45);
      box-shadow: 0 18px 32px -28px rgba(15, 23, 42, 0.8);
    }

    .chart-card h3 {
      margin: 0 0 0.4rem;
      font-size: 0.85rem;
      color: #cbd5f5;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 240px;
    }

    .chart-wrapper canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .paid-media-mode {
      display: flex;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    .paid-media-mode label {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
    }

    .input-group {
      display: grid;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }

    .margin-controls {
      display: grid;
      gap: 0.4rem;
    }

    .margin-inputs {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 0.35rem;
    }

    .margin-inputs input[type="range"] {
      width: 100%;
    }

    .margin-inputs input[type="number"] {
      width: 4rem;
      justify-self: end;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }

    .input-row label {
      font-size: 0.8rem;
      color: var(--muted);
    }

    #campaign-app {
      padding: 1.1rem;
    }

    .campaign-app {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 24px 48px -32px rgba(15, 23, 42, 0.8);
    }

    .campaign-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .campaign-toolbar h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #cbd5f5;
    }

    .campaign-toolbar p {
      margin: 0;
      color: var(--muted);
      font-size: 0.8rem;
    }

    .campaign-toolbar-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .campaign-toolbar select {
      width: auto;
      min-width: 180px;
    }

    .campaign-dashboard-empty {
      color: var(--muted);
      font-size: 0.85rem;
      margin-top: 1rem;
    }

    .campaign-list {
      display: grid;
      gap: 0.75rem;
    }

    .campaign-card {
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 12px;
      padding: 0.9rem;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .campaign-card h3 {
      margin: 0;
      font-size: 1rem;
    }

    .campaign-card-meta {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .campaign-card-meta span strong {
      color: #e2e8f0;
      display: block;
      font-size: 0.9rem;
    }

    .campaign-card-flags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }

    .campaign-flag {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 0.25rem 0.6rem;
      font-size: 0.7rem;
      color: var(--muted);
      background: rgba(148, 163, 184, 0.12);
    }

    .campaign-flag-urgent {
      color: var(--danger);
      border-color: rgba(248, 113, 113, 0.45);
      background: rgba(248, 113, 113, 0.15);
    }

    .campaign-card-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .campaign-card-actions button {
      min-width: 88px;
    }

    body.dashboard-active main,
    body.dashboard-active footer {
      display: none;
    }

    footer {
      padding: 1rem 2rem;
      text-align: center;
      color: var(--muted);
    }

    .danger-text {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>P.I.C</h1>
    <p>Precise. Influencer. Calculator.</p>
  </header>
  <div id="campaign-app"></div>
  <main>
    <div>
      <section id="campaign-details">
        <h2>Campaign Details</h2>
        <div class="details-grid">
          <label class="details-field" for="detail-brand">
            <span class="details-label">Brand</span>
            <input type="text" id="detail-brand" placeholder="e.g., Acme Co." />
          </label>
          <label class="details-field" for="detail-campaign">
            <span class="details-label">Campaign Name</span>
            <input type="text" id="detail-campaign" placeholder="Launch Campaign" />
          </label>
          <label class="details-field" for="detail-budget">
            <span class="details-label">Target Budget</span>
            <input type="text" id="detail-budget" placeholder="$250,000" />
          </label>
        </div>
        <div class="details-grid" style="margin-top:0.75rem;">
          <div class="details-field">
            <div class="details-label" style="display:flex; justify-content:space-between; align-items:center;">
              <span>Quarter</span>
              <span class="details-slider-value" id="quarter-display">Q1</span>
            </div>
            <input type="range" id="detail-quarter" min="1" max="4" step="1" list="quarter-marks" />
          </div>
          <div class="details-field">
            <div class="details-label" style="display:flex; justify-content:space-between; align-items:center;">
              <span>Brand Excitement</span>
              <span class="details-slider-value" id="excitement-display">Neutral</span>
            </div>
            <input type="range" id="detail-excitement" min="0" max="4" step="1" list="excitement-marks" />
          </div>
        </div>
        <div class="details-grid" style="margin-top:0.75rem;">
          <div class="details-field">
            <div class="details-label" style="display:flex; justify-content:space-between; align-items:center;">
              <span>Margin Goal</span>
              <span class="details-slider-value" id="margin-display">0%</span>
            </div>
            <div class="margin-inputs">
              <input type="range" id="margin-goal-slider" min="0" max="90" step="1" />
              <input type="number" id="margin-goal" min="0" max="90" step="1" />
            </div>
          </div>
        </div>
        <datalist id="quarter-marks">
          <option value="1" label="Q1"></option>
          <option value="2" label="Q2"></option>
          <option value="3" label="Q3"></option>
          <option value="4" label="Q4"></option>
        </datalist>
        <datalist id="excitement-marks">
          <option value="0" label="Loved"></option>
          <option value="1" label="Liked"></option>
          <option value="2" label="Neutral"></option>
          <option value="3" label="Disliked"></option>
          <option value="4" label="Hated"></option>
        </datalist>
        <div class="details-grid" style="margin-top:0.75rem;">
          <label class="details-checkbox" for="detail-rush">
            <input type="checkbox" id="detail-rush" />
            <span>Rush Fee (adds 15%)</span>
          </label>
          <label class="details-checkbox" for="detail-travel">
            <input type="checkbox" id="detail-travel" />
            <span>Travel Needed (adds 20%)</span>
          </label>
          <label class="details-checkbox" for="detail-niche">
            <input type="checkbox" id="detail-niche" />
            <span>Niche Creators Needed (adds 20%)</span>
          </label>
        </div>
      </section>

      <section>
        <h2>Build the Campaign</h2>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Platform</th>
                <th>Deliverable</th>
                <th>Creator Vertical</th>
                <th>Creator Language</th>
                <th>Creator Size</th>
                <th>Whitelist</th>
                <th>No. Creators</th>
                <th>No. Content Each</th>
                <th>Views per Piece</th>
                <th>Cogs CPV ($)</th>
                <th>Client CPV ($)</th>
                <th>Total COGs</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="campaign-body"></tbody>
          </table>
        </div>
        <div class="table-actions">
          <button id="add-line">Add Deliverable</button>
          <button class="secondary" id="reset-state">Reset All</button>
        </div>
      </section>

      <div class="section-pair">
        <section>
          <h2>Paid Media Options</h2>
          <div class="paid-media-mode">
            <label><input type="radio" name="paid-mode" value="cpv" /> CPV</label>
            <label><input type="radio" name="paid-mode" value="cpm" /> CPM Mode</label>
          </div>
          <div class="input-group">
            <div class="input-row">
              <label for="paid-budget">Paid Media Budget (Including Margin)</label>
              <input type="number" id="paid-budget" min="0" step="100" />
            </div>
            <div class="input-row">
              <label id="paid-rate-label" for="paid-rate">Client CPV (Including Margin)</label>
              <input type="number" id="paid-rate" min="0" step="0.001" />
            </div>
          </div>
        </section>

        <section>
          <h2>Travel &amp; Additional Costs</h2>
          <div class="input-group">
            <div class="input-row">
              <label for="other-costs">Other Costs</label>
              <input type="number" id="other-costs" min="0" step="100" />
            </div>
            <div class="input-row">
              <label for="study-costs">Study Costs</label>
              <input type="number" id="study-costs" min="0" step="100" />
            </div>
            <div class="input-row">
              <label for="additional-costs">Additional Costs</label>
              <input type="number" id="additional-costs" min="0" step="100" />
            </div>
          </div>
          <div id="travel-controls" class="input-group" style="display:none; margin-top:0.5rem;">
            <div class="input-row">
              <label for="travel-creators">Traveling Creators</label>
              <input type="number" id="travel-creators" min="0" step="1" />
            </div>
            <div class="input-row">
              <label for="travel-budget">Travel Budget / Creator</label>
              <input type="number" id="travel-budget" min="0" step="100" />
            </div>
          </div>
        </section>
      </div>

      <section class="chart-section">
        <h2>Campaign Insights</h2>
        <div class="chart-grid">
          <div class="chart-card">
            <h3>Budget Split by Platform</h3>
            <div class="chart-wrapper">
              <canvas id="platform-budget-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Budget Split by Language</h3>
            <div class="chart-wrapper">
              <canvas id="language-budget-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Budget Split by Creator Size</h3>
            <div class="chart-wrapper">
              <canvas id="size-budget-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Budget Split by Creator Vertical</h3>
            <div class="chart-wrapper">
              <canvas id="vertical-budget-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Estimated Views by Platform</h3>
            <div class="chart-wrapper">
              <canvas id="platform-view-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Content Pieces by Creator Size</h3>
            <div class="chart-wrapper">
              <canvas id="size-content-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Organic vs Paid Views</h3>
            <div class="chart-wrapper">
              <canvas id="view-mix-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Organic Influencer Cost vs Paid Media Budget</h3>
            <div class="chart-wrapper">
              <canvas id="investment-mix-chart"></canvas>
            </div>
          </div>
        </div>
      </section>
    </div>
    <aside>
      <div class="summary-card">
        <h3>Estimated Deliverables &amp; Commercials</h3>
        <div id="status-badge" class="status-badge status-ok">OK — Ready</div>
        <div class="summary-block">
          <p class="summary-block-title">Cost Breakdown</p>
          <div class="summary-grid" id="cost-summary"></div>
          <div id="budget-status" class="budget-status-card budget-status-neutral">
            <div class="budget-status-title">Budget Status</div>
            <div class="budget-status-value">No target budget set</div>
            <div class="budget-status-subtext">Enter a target budget in campaign details to compare.</div>
          </div>
        </div>
        <div class="summary-block">
          <p class="summary-block-title">Delivery Metrics</p>
          <div class="summary-grid" id="summary-grid"></div>
        </div>
        <div class="platform-breakdown" id="platform-breakdown"></div>
      </div>
    </aside>
  </main>
  <footer>
    State auto-saves locally. Refresh anytime and pick up where you left off.
  </footer>

  <script>
    /* =============================
       Constants (EMPTY tab mapping)
       =============================
       The workbook exposes key multipliers near rows 44563-44613. They are consolidated below for easy edits.
    */
    const LEGACY_STORAGE_KEY = 'precise-influencer-calculator-v1';
    const CAMPAIGN_STORAGE_KEY = 'pic-campaigns-v2';
    const TEMPLATE_STORAGE_KEY = 'pic-templates-v1';
    let persistActiveCampaign = () => {};
    // Generate a reasonably unique id when structuredClone is unavailable.
    function createId() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return `pic-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
    }

    // Read saved campaigns from localStorage and normalise their structure.
    function loadCampaigns() {
      try {
        const raw = localStorage.getItem(CAMPAIGN_STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(entry => createCampaignRecord(entry.data ?? entry, entry.id, entry.name));
      } catch (err) {
        console.error('Failed to load campaigns', err);
        return [];
      }
    }

    // Persist the current campaign collection for dashboard use.
    function saveCampaigns(campaigns) {
      try {
        localStorage.setItem(CAMPAIGN_STORAGE_KEY, JSON.stringify(campaigns));
      } catch (err) {
        console.error('Failed to save campaigns', err);
      }
    }

    // Restore saved templates from localStorage.
    function loadTemplates() {
      try {
        const raw = localStorage.getItem(TEMPLATE_STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(template => ({
          id: template.id ?? createId(),
          name: template.name ?? 'Template',
          deliverables: Array.isArray(template.deliverables) ? template.deliverables : [],
        }));
      } catch (err) {
        console.error('Failed to load templates', err);
        return [];
      }
    }

    // Persist reusable deliverable templates locally.
    function saveTemplates(templates) {
      try {
        localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(templates));
      } catch (err) {
        console.error('Failed to save templates', err);
      }
    }

    // Prefer campaign collection storage but fall back to legacy single-state save.
    function bootstrapCampaigns() {
      const stored = loadCampaigns();
      if (stored.length) {
        return stored;
      }
      try {
        const legacyRaw = localStorage.getItem(LEGACY_STORAGE_KEY);
        if (!legacyRaw) return [];
        const parsed = JSON.parse(legacyRaw);
        const record = createCampaignRecord(parsed);
        const seeded = [record];
        saveCampaigns(seeded);
        return seeded;
      } catch (err) {
        console.error('Failed to import legacy campaign', err);
        return [];
      }
    }

    const chartStates = {
      platformBudget: createChartState('platform-budget-chart'),
      sizeBudget: createChartState('size-budget-chart'),
      platformViews: createChartState('platform-view-chart'),
      viewMix: createChartState('view-mix-chart'),
      languageBudget: createChartState('language-budget-chart'),
      verticalBudget: createChartState('vertical-budget-chart'),
      sizeContent: createChartState('size-content-chart', createCountTooltipFormatter('pieces')),
      investmentMix: createChartState('investment-mix-chart'),
    };
    chartStates.sizeContent.defaultType = 'bar';
    chartStates.sizeContent.alternateType = 'pie';
    chartStates.sizeContent.currentType = 'bar';

    const CPV_WITH_MARGIN_LABEL = 'Client CPV (Including Margin)';

    const DEFAULT_PAID_RATES = {
      cpv: 0.03,
      cpm: 12,
    };

    const pricingVariables = {
      rateCard: JSON.parse(JSON.stringify(RATE_CARD)),
      sizeMultipliers: JSON.parse(JSON.stringify(SIZE_MULT)),
      sizeFollowers: JSON.parse(JSON.stringify(SIZE_FOLLOWERS)),
      verticalMultipliers: JSON.parse(JSON.stringify(VERTICAL_MULT)),
      languageMultipliers: JSON.parse(JSON.stringify(LANGUAGE_MULT)),
      whitelistUplift: JSON.parse(JSON.stringify(WHITELIST_UPLIFT_PCT)),
      brandExcitement: JSON.parse(JSON.stringify(BRAND_EXCITEMENT)),
      defaultPaidRates: JSON.parse(JSON.stringify(DEFAULT_PAID_RATES)),
      rushFeePercentage: 0.15,
      travelFeePercentage: 0.2,
      nicheFeePercentage: 0.2,
      q4FeePercentage: 0.15,
    };

    const SIZE_MULT = {
      Icon: { views: 2.5 },
      Mega: { views: 1.5 },
      Macro: { views: 1 },
      HMid: { views: 0.5 },
      LMid: { views: 0.25 },
      Micro: { views: 0.05 },
    };

    const SIZE_FOLLOWERS = {
      Icon: 2000000,
      Mega: 1000000,
      Macro: 500000,
      HMid: 250000,
      LMid: 50000,
      Micro: 10000,
    };

    const VERTICAL_MULT = {
      Gaming: { rate: 1, views: 1.05 },
      'Mobile Gaming': { rate: 1, views: 1.05 },
      'Beauty/Fashion': { rate: 1, views: 1.1 },
      Lifestyle: { rate: 1, views: 1.08 },
      Tech: { rate: 1, views: 1 },
    };

    const LANGUAGE_MULT = {
      English: { rate: 1, views: 1 },
      French: { rate: 1.3, views: 1 },
      German: { rate: 1.3, views: 1 },
      Italian: { rate: 1.3, views: 1 },
      Spanish: { rate: 0.8, views: 1 },
      Portuguese: { rate: 0.8, views: 1 },
    };

    const WHITELIST_UPLIFT_PCT = {
      Icon: 0.3,
      Mega: 0.3,
      Macro: 0.3,
      HMid: 0.3,
      LMid: 0.1,
      Micro: 0,
    };

    // Each deliverable stores a base macro view count and creator CPV so we can derive
    // consistent pricing across creator sizes while still allowing vertical/language uplifts.
    // Size only impacts view expectations—pricing comes from the base rate plus other multipliers.
    // When tier-specific view goals are available, a `viewsBySize` map overrides the generic
    // size multiplier to reflect those expectations directly.
    const RATE_CARD = {
      YouTube: {
        deliverables: {
          Dedicated: {
            baseViews: 200000,
            cpv: 0.094,
            cpvByVertical: {
              Gaming: 0.064,
              'Mobile Gaming': 0.096,
              'Beauty/Fashion': 0.128,
              Lifestyle: 0.085,
              Tech: 0.081,
            },
            viewsBySize: {
              Icon: 500000,
              Mega: 300000,
              Macro: 200000,
              HMid: 100000,
              LMid: 50000,
              Micro: 10000,
            },
          },
          Integrated: {
            baseViews: 200000,
            cpv: 0.054,
            cpvByVertical: {
              Gaming: 0.032,
              'Mobile Gaming': 0.048,
              'Beauty/Fashion': 0.072,
              Lifestyle: 0.049,
              Tech: 0.049,
            },
            viewsBySize: {
              Icon: 500000,
              Mega: 300000,
              Macro: 200000,
              HMid: 100000,
              LMid: 50000,
              Micro: 10000,
            },
          },
          Shorts: {
            baseViews: 200000,
            cpv: 0.054,
            viewsBySize: {
              Icon: 500000,
              Mega: 300000,
              Macro: 200000,
              HMid: 100000,
              LMid: 50000,
              Micro: 10000,
            },
          },
          Stream: {
            baseViews: 10000,
            cpv: 0.935,
            cpvByVertical: {
              Gaming: 0.85,
              'Mobile Gaming': 1.275,
              'Beauty/Fashion': 0.85,
              Lifestyle: 0.85,
              Tech: 0.85,
            },
            viewsBySize: {
              Icon: 20000,
              Mega: 15000,
              Macro: 10000,
              HMid: 5000,
              LMid: 500,
              Micro: 100,
            },
          },
        },
      },
      Instagram: {
        deliverables: {
          Reel: {
            baseViews: 100000,
            cpv: 0.056,
            cpvByVertical: {
              Gaming: 0.055,
              'Mobile Gaming': 0.083,
              'Beauty/Fashion': 0.072,
              Lifestyle: 0.064,
              Tech: 0.072,
            },
            viewsBySize: {
              Icon: 300000,
              Mega: 200000,
              Macro: 100000,
              HMid: 50000,
              LMid: 30000,
              Micro: 10000,
            },
          },
          Video: {
            baseViews: 100000,
            cpv: 0.056,
            cpvByVertical: {
              Gaming: 0.055,
              'Mobile Gaming': 0.083,
              'Beauty/Fashion': 0.072,
              Lifestyle: 0.064,
              Tech: 0.072,
            },
            viewsBySize: {
              Icon: 300000,
              Mega: 200000,
              Macro: 100000,
              HMid: 50000,
              LMid: 30000,
              Micro: 10000,
            },
          },
          Story: {
            baseViews: 55000,
            cpv: 0.042,
            cpvByVertical: {
              Gaming: 0.03,
              'Mobile Gaming': 0.045,
              'Beauty/Fashion': 0.045,
              Lifestyle: 0.038,
              Tech: 0.038,
            },
            viewsBySize: {
              Icon: 150000,
              Mega: 110000,
              Macro: 55000,
              HMid: 20000,
              LMid: 5000,
              Micro: 1000,
            },
          },
          Photo: {
            baseViews: 39000,
            cpv: 0.049,
            cpvByVertical: {
              Gaming: 0.039,
              'Mobile Gaming': 0.058,
              'Beauty/Fashion': 0.051,
              Lifestyle: 0.045,
              Tech: 0.051,
            },
          },
        },
      },
      TikTok: {
        deliverables: {
          Video: {
            baseViews: 100000,
            cpv: 0.056,
            cpvByVertical: {
              Gaming: 0.043,
              'Mobile Gaming': 0.064,
              'Beauty/Fashion': 0.058,
              Lifestyle: 0.051,
              Tech: 0.055,
            },
            viewsBySize: {
              Icon: 300000,
              Mega: 200000,
              Macro: 100000,
              HMid: 50000,
              LMid: 30000,
              Micro: 10000,
            },
          },
          Live: { baseViews: 60000, cpv: 0.367 },
        },
      },
      Twitch: {
        deliverables: {
          Stream: {
            baseViews: 10000,
            cpv: 0.935,
            cpvByVertical: {
              Gaming: 0.85,
              'Mobile Gaming': 1.275,
              'Beauty/Fashion': 0.85,
              Lifestyle: 0.85,
              Tech: 0.85,
            },
            viewsBySize: {
              Icon: 20000,
              Mega: 15000,
              Macro: 10000,
              HMid: 5000,
              LMid: 500,
              Micro: 100,
            },
          },
        },
      },
      Twitter: {
        deliverables: {
          Video: {
            baseViews: 50000,
            cpv: 0.042,
            cpvByVertical: {
              Gaming: 0.03,
              'Mobile Gaming': 0.045,
              'Beauty/Fashion': 0.045,
              Lifestyle: 0.038,
              Tech: 0.038,
            },
          },
        },
      },
    };

    const QUARTER_LABELS = ['Q1', 'Q2', 'Q3', 'Q4'];
    const BRAND_EXCITEMENT = [
      { label: 'Loved', multiplier: 0.85 },
      { label: 'Liked', multiplier: 0.93 },
      { label: 'Neutral', multiplier: 1 },
      { label: 'Disliked', multiplier: 1.08 },
      { label: 'Hated', multiplier: 1.15 },
    ];

    function createDefaultLine() {
      const platform = Object.keys(RATE_CARD)[0];
      const deliverable = Object.keys(RATE_CARD[platform].deliverables)[0];
      const size = 'Macro';
      const vertical = Object.keys(VERTICAL_MULT)[0];
      const language = Object.keys(LANGUAGE_MULT)[0];
      const defaults = getRateDefaults(platform, deliverable, size, vertical, language);
      return {
        platform,
        deliverable,
        vertical,
        language,
        size,
        whitelist: false,
        unitRate: defaults.cpv,
        qtyPerCreator: 0,
        creators: 0,
        viewsPerPiece: defaults.views,
        manualViews: false,
      };
    }

    function applyLineDefaults(line, options = {}) {
      const { forceViews = false } = options;
      const defaults = getRateDefaults(line.platform, line.deliverable, line.size, line.vertical, line.language);
      line.unitRate = defaults.cpv;
      if (forceViews || !line.manualViews) {
        line.viewsPerPiece = defaults.views;
      }
      return line;
    }

    function getRateDefaults(platform, deliverable, size, vertical, language) {
      const base = RATE_CARD[platform]?.deliverables?.[deliverable] || { baseViews: 0, cpv: 0 };
      const sizeAdjust = SIZE_MULT[size] || { views: 1 };
      const verticalAdjust = VERTICAL_MULT[vertical] || { rate: 1, views: 1 };
      const languageAdjust = LANGUAGE_MULT[language] || { rate: 1, views: 1 };
      const baseViews = base.viewsBySize
        ? base.viewsBySize[size] ?? base.viewsBySize.Macro ?? base.baseViews ?? 0
        : base.baseViews || 0;
      const sizeViewMultiplier = base.viewsBySize ? 1 : (sizeAdjust.views ?? 1);
      const views = Math.round(
        baseViews
          * sizeViewMultiplier
          * (verticalAdjust.views ?? 1)
          * (languageAdjust.views ?? 1),
      );
      const cpvOverride = base.cpvByVertical?.[vertical];
      const hasOverride = Number.isFinite(cpvOverride);
      const cpvBase = hasOverride ? Number(cpvOverride) : (base.cpv || 0);
      let cpvRaw = cpvBase
        * (languageAdjust.rate ?? 1);
      if (!hasOverride) {
        cpvRaw *= (verticalAdjust.rate ?? 1);
      }
      return {
        cpv: Number.isFinite(cpvRaw) ? Number(cpvRaw.toFixed(3)) : 0,
        views,
      };
    }

    const defaultState = {
      details: {
        brand: '',
        campaignName: '',
        budget: '',
        quarter: 1,
        brandExcitement: 1,
        rush: false,
        travelNeeded: false,
        nicheCreators: false,
      },
      otherCosts: {
        other: 0,
        study: 0,
        additional: 0,
      },
      travel: {
        creators: 0,
        perCreator: 0,
      },
      campaignLines: [createDefaultLine()],
      paidMedia: {
        mode: 'cpv',
        budget: 0,
        rate: DEFAULT_PAID_RATES.cpv,
      },
      marginGoal: 0,
    };

    let state = loadState();

    // Merge raw persisted data with calculator defaults to keep structures stable.
    function normalizeCampaignState(source) {
      const base = structuredClone(defaultState);
      if (!source || typeof source !== 'object') {
        return base;
      }
      const parsed = structuredClone(source);
      const mergedPaidMedia = { ...base.paidMedia, ...(parsed.paidMedia || {}) };
      if (!mergedPaidMedia.rate || mergedPaidMedia.rate <= 0) {
        mergedPaidMedia.rate = DEFAULT_PAID_RATES[mergedPaidMedia.mode] ?? DEFAULT_PAID_RATES.cpv;
      }
      const sourceLines = Array.isArray(parsed.campaignLines) && parsed.campaignLines.length
        ? parsed.campaignLines
        : base.campaignLines;
      const normalizedLines = sourceLines.map(line => {
        const merged = { ...createDefaultLine(), ...structuredClone(line) };
        merged.manualViews = false;
        return applyLineDefaults(merged, { forceViews: true });
      });
      return {
        ...base,
        marginGoal: parsed.marginGoal ?? base.marginGoal,
        details: { ...base.details, ...(parsed.details || {}) },
        otherCosts: { ...base.otherCosts, ...(parsed.otherCosts || {}) },
        travel: { ...base.travel, ...(parsed.travel || {}) },
        campaignLines: normalizedLines,
        paidMedia: mergedPaidMedia,
      };
    }

    // Load the active calculator state, defaulting to legacy storage when available.
    function loadState(rawSource) {
      try {
        if (rawSource) {
          return normalizeCampaignState(rawSource);
        }
        const raw = localStorage.getItem(LEGACY_STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        return normalizeCampaignState(parsed);
      } catch (err) {
        console.error('Failed to load state', err);
        return structuredClone(defaultState);
      }
    }

    // Derive summary metrics used for dashboard previews.
    function calculateCampaignSummaryFromData(campaignState) {
      const modifiers = calculateModifiers(campaignState);
      const organicViewsRaw = (campaignState.campaignLines || []).reduce((acc, line) => {
        const views = (line.viewsPerPiece || 0) * (line.qtyPerCreator || 0) * (line.creators || 0);
        return acc + views;
      }, 0);
      const organicViewsAdjusted = organicViewsRaw * (modifiers.organicViewMultiplier ?? 1);
      const paidViews = calculatePaidViews(campaignState.paidMedia);
      const totalViews = organicViewsAdjusted + paidViews;
      const totalCreators = (campaignState.campaignLines || []).reduce(
        (acc, line) => acc + (line.creators || 0),
        0,
      );
      return { totalViews, totalCreators };
    }

    // Convert a raw calculator state into a dashboard-ready campaign record.
    function createCampaignRecord(rawState, id, nameOverride) {
      const normalized = normalizeCampaignState(rawState || {});
      const data = structuredClone(normalized);
      if (nameOverride) {
        data.details.campaignName = nameOverride;
      }
      const detailsName = (data.details?.campaignName || '').trim();
      const finalName = nameOverride ?? (detailsName || 'Untitled Campaign');
      const summary = calculateCampaignSummaryFromData(data);
      const brand = (data.details?.brand || '').trim();
      const rawQuarter = Number(data.details?.quarter);
      const quarterIndex = Number.isFinite(rawQuarter)
        ? Math.min(Math.max(Math.floor(rawQuarter), 1), QUARTER_LABELS.length)
        : null;
      const quarterLabel = quarterIndex
        ? QUARTER_LABELS[quarterIndex - 1] ?? `Q${quarterIndex}`
        : null;
      const deliverableCount = Array.isArray(data.campaignLines) ? data.campaignLines.length : 0;
      const rush = !!data.details?.rush;
      const travelNeeded = !!data.details?.travelNeeded;
      const nicheCreators = !!data.details?.nicheCreators;
      return {
        id: id ?? createId(),
        name: finalName,
        budget: parseCurrencyInput(data.details?.budget),
        totalCreators: summary.totalCreators,
        estimatedViews: summary.totalViews,
        brand,
        quarter: quarterIndex,
        quarterLabel,
        deliverableCount,
        rush,
        travelNeeded,
        nicheCreators,
        data,
      };
    }

    // Pick only the deliverable fields that a template should remember.
    function sanitizeTemplateLines(sourceState) {
      const lines = sourceState?.campaignLines || [];
      return lines.map(line => ({
        platform: line.platform,
        deliverable: line.deliverable,
        vertical: line.vertical,
        language: line.language,
        size: line.size,
        whitelist: !!line.whitelist,
        creators: Number(line.creators || 0),
        qtyPerCreator: Number(line.qtyPerCreator || 0),
        viewsPerPiece: Number(line.viewsPerPiece || 0),
        unitRate: Number(line.unitRate || 0),
      }));
    }

    // Apply a template payload to a fresh calculator state instance.
    function applyTemplateToState(stateData, template) {
      if (!template) return stateData;
      const deliverables = Array.isArray(template.deliverables) && template.deliverables.length
        ? template.deliverables
        : [createDefaultLine()];
      stateData.campaignLines = deliverables.map(line => {
        const merged = { ...createDefaultLine(), ...structuredClone(line) };
        merged.manualViews = false;
        return applyLineDefaults(merged, { forceViews: true });
      });
      return stateData;
    }

    // Push a campaign payload into the DOM-driven editor experience.
    function hydrateActiveCampaign(rawState) {
      state = loadState(rawState);
      syncCampaignDetailsInputs();
      renderCampaign();
      syncPaidMediaInputs();
      syncOtherCostInputs();
      syncMarginControls();
      recalc();
    }

    function saveState() {
      try {
        localStorage.setItem(LEGACY_STORAGE_KEY, JSON.stringify(state));
      } catch (err) {
        console.error('Failed to persist legacy state', err);
      }
      if (typeof persistActiveCampaign === 'function') {
        try {
          persistActiveCampaign(structuredClone(state));
        } catch (err) {
          console.error('Failed to sync campaign collection', err);
        }
      }
    }

    function init() {
      bindCampaignDetails();
      renderCampaign();
      bindPaidMedia();
      bindOtherCosts();
      bindSummaryControls();
      recalc();
    }

    function bindCampaignDetails() {
      const brandInput = document.getElementById('detail-brand');
      const campaignInput = document.getElementById('detail-campaign');
      const budgetInput = document.getElementById('detail-budget');
      const quarterInput = document.getElementById('detail-quarter');
      const excitementInput = document.getElementById('detail-excitement');
      const rushInput = document.getElementById('detail-rush');
      const travelInput = document.getElementById('detail-travel');
      const nicheInput = document.getElementById('detail-niche');

      if (!brandInput) return;

      brandInput.addEventListener('input', () => {
        state.details.brand = brandInput.value;
        saveState();
        recalc();
      });

      campaignInput.addEventListener('input', () => {
        state.details.campaignName = campaignInput.value;
        saveState();
        recalc();
      });

      budgetInput.addEventListener('input', () => {
        state.details.budget = budgetInput.value;
        saveState();
        recalc();
      });

      quarterInput.addEventListener('input', () => {
        const value = Math.min(Math.max(Number(quarterInput.value) || 1, 1), QUARTER_LABELS.length);
        state.details.quarter = value;
        updateQuarterDisplay(value);
        saveState();
        recalc();
      });

      excitementInput.addEventListener('input', () => {
        const maxIndex = BRAND_EXCITEMENT.length - 1;
        const value = Math.min(Math.max(Number(excitementInput.value) || 0, 0), maxIndex);
        state.details.brandExcitement = value;
        updateExcitementDisplay(value);
        saveState();
        recalc();
      });

      rushInput.addEventListener('change', () => {
        state.details.rush = rushInput.checked;
        saveState();
        recalc();
      });

      travelInput.addEventListener('change', () => {
        state.details.travelNeeded = travelInput.checked;
        saveState();
        updateTravelControls();
        recalc();
      });

      nicheInput.addEventListener('change', () => {
        state.details.nicheCreators = nicheInput.checked;
        saveState();
        recalc();
      });

      syncCampaignDetailsInputs();
    }

    function updateQuarterDisplay(value) {
      const display = document.getElementById('quarter-display');
      const index = Math.min(Math.max(Number(value) || 1, 1), QUARTER_LABELS.length) - 1;
      if (display) {
        display.textContent = QUARTER_LABELS[index] ?? `Q${index + 1}`;
      }
    }

    function updateExcitementDisplay(value) {
      const display = document.getElementById('excitement-display');
      const index = Math.min(Math.max(Number(value) || 0, 0), BRAND_EXCITEMENT.length - 1);
      if (display) {
        display.textContent = BRAND_EXCITEMENT[index]?.label ?? 'Neutral';
      }
    }

    function syncCampaignDetailsInputs() {
      const { details } = state;
      const brandInput = document.getElementById('detail-brand');
      const campaignInput = document.getElementById('detail-campaign');
      const budgetInput = document.getElementById('detail-budget');
      const quarterInput = document.getElementById('detail-quarter');
      const excitementInput = document.getElementById('detail-excitement');
      const rushInput = document.getElementById('detail-rush');
      const travelInput = document.getElementById('detail-travel');
      const nicheInput = document.getElementById('detail-niche');

      if (!brandInput) return;

      brandInput.value = details.brand || '';
      campaignInput.value = details.campaignName || '';
      budgetInput.value = details.budget || '';
      const rawQuarter = Number(details.quarter);
      const quarterValue = Math.min(
        Math.max(Number.isFinite(rawQuarter) && rawQuarter >= 1 ? rawQuarter : 1, 1),
        QUARTER_LABELS.length,
      );
      quarterInput.value = String(quarterValue);
      updateQuarterDisplay(quarterValue);
      const rawExcitement = Number(details.brandExcitement);
      const excitementValue = Math.min(
        Math.max(Number.isFinite(rawExcitement) ? rawExcitement : 1, 0),
        BRAND_EXCITEMENT.length - 1,
      );
      excitementInput.value = String(excitementValue);
      updateExcitementDisplay(excitementValue);
      rushInput.checked = !!details.rush;
      travelInput.checked = !!details.travelNeeded;
      nicheInput.checked = !!details.nicheCreators;
      updateTravelControls();
    }

    function updateTravelControls() {
      const travelBlock = document.getElementById('travel-controls');
      if (!travelBlock) return;
      travelBlock.style.display = state.details.travelNeeded ? 'grid' : 'none';
    }

    function renderCampaign() {
      const tbody = document.getElementById('campaign-body');
      tbody.innerHTML = '';
      state.campaignLines.forEach((line, index) => {
        const tr = document.createElement('tr');

        const verticalOptions = Object.keys(VERTICAL_MULT);
        if (!verticalOptions.includes(line.vertical)) {
          line.vertical = verticalOptions[0];
        }
        const languageOptions = Object.keys(LANGUAGE_MULT);
        if (!languageOptions.includes(line.language)) {
          line.language = languageOptions[0];
        }
        line.manualViews = false;
        applyLineDefaults(line, { forceViews: true });

        const platformTd = document.createElement('td');
        const platformSelect = document.createElement('select');
        Object.keys(RATE_CARD).forEach(platform => {
          const opt = document.createElement('option');
          opt.value = platform;
          opt.textContent = platform;
          if (platform === line.platform) opt.selected = true;
          platformSelect.appendChild(opt);
        });
        platformSelect.addEventListener('change', () => {
          line.platform = platformSelect.value;
          const deliverables = Object.keys(RATE_CARD[line.platform].deliverables);
          if (!deliverables.includes(line.deliverable)) {
            line.deliverable = deliverables[0];
          }
          line.manualViews = false;
          applyLineDefaults(line, { forceViews: true });
          renderCampaign();
          saveState();
          recalc();
        });
        platformTd.appendChild(platformSelect);
        tr.appendChild(platformTd);

        const deliverableTd = document.createElement('td');
        const deliverableSelect = document.createElement('select');
        const deliverableOptions = RATE_CARD[line.platform]?.deliverables || {};
        Object.keys(deliverableOptions).forEach(deliverable => {
          const opt = document.createElement('option');
          opt.value = deliverable;
          opt.textContent = deliverable;
          if (deliverable === line.deliverable) opt.selected = true;
          deliverableSelect.appendChild(opt);
        });
        deliverableSelect.addEventListener('change', () => {
          line.deliverable = deliverableSelect.value;
          line.manualViews = false;
          applyLineDefaults(line, { forceViews: true });
          renderCampaign();
          saveState();
          recalc();
        });
        deliverableTd.appendChild(deliverableSelect);
        tr.appendChild(deliverableTd);

        const verticalTd = document.createElement('td');
        const verticalSelect = document.createElement('select');
        Object.keys(VERTICAL_MULT).forEach(vertical => {
          const opt = document.createElement('option');
          opt.value = vertical;
          opt.textContent = vertical;
          if (vertical === line.vertical) opt.selected = true;
          verticalSelect.appendChild(opt);
        });
        verticalSelect.addEventListener('change', () => {
          line.vertical = verticalSelect.value;
          line.manualViews = false;
          applyLineDefaults(line, { forceViews: true });
          renderCampaign();
          saveState();
          recalc();
        });
        verticalTd.appendChild(verticalSelect);
        tr.appendChild(verticalTd);

        const languageTd = document.createElement('td');
        const languageSelect = document.createElement('select');
        Object.keys(LANGUAGE_MULT).forEach(language => {
          const opt = document.createElement('option');
          opt.value = language;
          opt.textContent = language;
          if (language === line.language) opt.selected = true;
          languageSelect.appendChild(opt);
        });
        languageSelect.addEventListener('change', () => {
          line.language = languageSelect.value;
          line.manualViews = false;
          applyLineDefaults(line, { forceViews: true });
          renderCampaign();
          saveState();
          recalc();
        });
        languageTd.appendChild(languageSelect);
        tr.appendChild(languageTd);

        const sizeTd = document.createElement('td');
        const sizeSelect = document.createElement('select');
        Object.keys(SIZE_MULT).forEach(size => {
          const opt = document.createElement('option');
          opt.value = size;
          opt.textContent = size;
          if (size === line.size) opt.selected = true;
          sizeSelect.appendChild(opt);
        });
        sizeSelect.addEventListener('change', () => {
          line.size = sizeSelect.value;
          line.manualViews = false;
          applyLineDefaults(line, { forceViews: true });
          renderCampaign();
          saveState();
          recalc();
        });
        sizeTd.appendChild(sizeSelect);
        tr.appendChild(sizeTd);

        const whitelistTd = document.createElement('td');
        const whitelistCheckbox = document.createElement('input');
        whitelistCheckbox.type = 'checkbox';
        whitelistCheckbox.checked = line.whitelist;
        whitelistCheckbox.addEventListener('change', () => {
          line.whitelist = whitelistCheckbox.checked;
          saveState();
          recalc();
        });
        whitelistTd.appendChild(whitelistCheckbox);
        tr.appendChild(whitelistTd);

        const creatorsTd = document.createElement('td');
        const creatorsInput = document.createElement('input');
        creatorsInput.type = 'number';
        creatorsInput.min = '0';
        creatorsInput.step = '1';
        creatorsInput.value = Number(line.creators || 0);
        creatorsInput.addEventListener('change', () => {
          line.creators = parseFloat(creatorsInput.value) || 0;
          saveState();
          recalc();
        });
        creatorsTd.appendChild(creatorsInput);
        tr.appendChild(creatorsTd);

        const contentTd = document.createElement('td');
        const contentInput = document.createElement('input');
        contentInput.type = 'number';
        contentInput.min = '0';
        contentInput.step = '1';
        contentInput.value = Number(line.qtyPerCreator || 0);
        contentInput.addEventListener('change', () => {
          line.qtyPerCreator = parseFloat(contentInput.value) || 0;
          saveState();
          recalc();
        });
        contentTd.appendChild(contentInput);
        tr.appendChild(contentTd);

        const viewsTd = document.createElement('td');
        const viewsDisplay = document.createElement('div');
        viewsDisplay.className = 'readonly-value';
        viewsDisplay.textContent = formatNumber(line.viewsPerPiece || 0);
        viewsTd.appendChild(viewsDisplay);
        tr.appendChild(viewsTd);

        const currentLineTotal = calculateLineTotal(line);

        const cogsCpvTd = document.createElement('td');
        const cogsCpvDisplay = document.createElement('div');
        cogsCpvDisplay.className = 'readonly-value cogs-cpv';
        const initialCogsCpv = Number.isFinite(line.cpvWithWhitelist)
          ? line.cpvWithWhitelist
          : line.unitRate || 0;
        cogsCpvDisplay.textContent = formatCpv(initialCogsCpv);
        cogsCpvTd.appendChild(cogsCpvDisplay);
        tr.appendChild(cogsCpvTd);

        const clientCpvTd = document.createElement('td');
        const clientCpvDisplay = document.createElement('div');
        clientCpvDisplay.className = 'readonly-value client-cpv';
        clientCpvDisplay.textContent = formatCpv(initialCogsCpv);
        clientCpvTd.appendChild(clientCpvDisplay);
        tr.appendChild(clientCpvTd);

        const lineTotalTd = document.createElement('td');
        lineTotalTd.textContent = formatCurrency(currentLineTotal);
        tr.appendChild(lineTotalTd);

        const deleteTd = document.createElement('td');
        if (state.campaignLines.length > 1) {
          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'Remove';
          removeBtn.className = 'secondary';
          removeBtn.addEventListener('click', () => {
            state.campaignLines.splice(index, 1);
            saveState();
            renderCampaign();
            recalc();
          });
          deleteTd.appendChild(removeBtn);
        }
        tr.appendChild(deleteTd);

        tbody.appendChild(tr);
      });

      document.getElementById('add-line').onclick = () => {
        state.campaignLines.push(createDefaultLine());
        saveState();
        renderCampaign();
        recalc();
      };

      document.getElementById('reset-state').onclick = () => {
        if (confirm('Reset calculator to defaults?')) {
          state = structuredClone(defaultState);
          saveState();
          syncCampaignDetailsInputs();
          renderCampaign();
          bindPaidMedia();
          bindOtherCosts();
          bindSummaryControls();
          recalc();
        }
      };
    }

    function calculateLineTotal(line) {
      applyLineDefaults(line);
      const cpv = line.unitRate || 0;
      const viewsPerPiece = line.viewsPerPiece || 0;
      const perCreatorBase = cpv * viewsPerPiece * (line.qtyPerCreator || 0);
      // Mirrors EMPTY workbook calc: base rate * qty * whitelist multiplier
      const whitelistMultiplier = line.whitelist
        ? 1 + (WHITELIST_UPLIFT_PCT[line.size] ?? 0.2)
        : 1;
      const cogsPerCreator = perCreatorBase * whitelistMultiplier;
      line.cogsPerCreator = cogsPerCreator;
      line.cpvWithWhitelist = cpv * whitelistMultiplier;
      return cogsPerCreator * (line.creators || 0);
    }

    function bindPaidMedia() {
      const modeInputs = document.querySelectorAll('input[name="paid-mode"]');
      const budgetInput = document.getElementById('paid-budget');
      const rateInput = document.getElementById('paid-rate');

      if (!state.paidMedia.rate || state.paidMedia.rate <= 0) {
        state.paidMedia.rate = DEFAULT_PAID_RATES[state.paidMedia.mode] ?? DEFAULT_PAID_RATES.cpv;
      }

      modeInputs.forEach(input => {
        input.checked = state.paidMedia.mode === input.value;
        input.addEventListener('change', () => {
          if (input.checked) {
            const previousMode = state.paidMedia.mode;
            const previousRate = state.paidMedia.rate;
            state.paidMedia.mode = input.value;
            if (!previousRate || previousRate === (DEFAULT_PAID_RATES[previousMode] ?? DEFAULT_PAID_RATES.cpv)) {
              state.paidMedia.rate = DEFAULT_PAID_RATES[state.paidMedia.mode] ?? DEFAULT_PAID_RATES.cpv;
            }
            rateInput.value = Number(state.paidMedia.rate || 0);
            saveState();
            updatePaidRateLabel();
            recalc();
          }
        });
      });

      budgetInput.value = Number(state.paidMedia.budget || 0);
      budgetInput.addEventListener('change', () => {
        state.paidMedia.budget = parseFloat(budgetInput.value) || 0;
        saveState();
        recalc();
      });

      rateInput.value = Number(state.paidMedia.rate || 0);
      rateInput.addEventListener('change', () => {
        state.paidMedia.rate = parseFloat(rateInput.value) || 0;
        saveState();
        recalc();
      });

      updatePaidRateLabel();
    }

    function syncPaidMediaInputs() {
      const modeInputs = document.querySelectorAll('input[name="paid-mode"]');
      modeInputs.forEach(input => {
        input.checked = state.paidMedia.mode === input.value;
      });
      const budgetInput = document.getElementById('paid-budget');
      if (budgetInput) {
        budgetInput.value = Number(state.paidMedia.budget || 0);
      }
      const rateInput = document.getElementById('paid-rate');
      if (rateInput) {
        rateInput.value = Number(state.paidMedia.rate || 0);
      }
      updatePaidRateLabel();
    }

    function updatePaidRateLabel() {
      const label = document.getElementById('paid-rate-label');
      const isCpm = state.paidMedia.mode === 'cpm';
      label.textContent = isCpm ? 'CPM' : CPV_WITH_MARGIN_LABEL;
      const rateInput = document.getElementById('paid-rate');
      rateInput.step = isCpm ? '0.1' : '0.001';
      rateInput.placeholder = (DEFAULT_PAID_RATES[state.paidMedia.mode] ?? DEFAULT_PAID_RATES.cpv).toString();
    }

    function bindOtherCosts() {
      const otherInput = document.getElementById('other-costs');
      const studyInput = document.getElementById('study-costs');
      const additionalInput = document.getElementById('additional-costs');
      const travelCreators = document.getElementById('travel-creators');
      const travelBudget = document.getElementById('travel-budget');

      otherInput.value = Number(state.otherCosts.other || 0);
      studyInput.value = Number(state.otherCosts.study || 0);
      additionalInput.value = Number(state.otherCosts.additional || 0);
      travelCreators.value = Number(state.travel.creators || 0);
      travelBudget.value = Number(state.travel.perCreator || 0);

      otherInput.addEventListener('change', () => {
        state.otherCosts.other = parseFloat(otherInput.value) || 0;
        saveState();
        recalc();
      });
      studyInput.addEventListener('change', () => {
        state.otherCosts.study = parseFloat(studyInput.value) || 0;
        saveState();
        recalc();
      });
      additionalInput.addEventListener('change', () => {
        state.otherCosts.additional = parseFloat(additionalInput.value) || 0;
        saveState();
        recalc();
      });
      travelCreators.addEventListener('change', () => {
        state.travel.creators = parseFloat(travelCreators.value) || 0;
        saveState();
        recalc();
      });
      travelBudget.addEventListener('change', () => {
        state.travel.perCreator = parseFloat(travelBudget.value) || 0;
        saveState();
        recalc();
      });
    }

    function syncOtherCostInputs() {
      const otherInput = document.getElementById('other-costs');
      if (otherInput) {
        otherInput.value = Number(state.otherCosts.other || 0);
      }
      const studyInput = document.getElementById('study-costs');
      if (studyInput) {
        studyInput.value = Number(state.otherCosts.study || 0);
      }
      const additionalInput = document.getElementById('additional-costs');
      if (additionalInput) {
        additionalInput.value = Number(state.otherCosts.additional || 0);
      }
      const travelCreators = document.getElementById('travel-creators');
      if (travelCreators) {
        travelCreators.value = Number(state.travel.creators || 0);
      }
      const travelBudget = document.getElementById('travel-budget');
      if (travelBudget) {
        travelBudget.value = Number(state.travel.perCreator || 0);
      }
      updateTravelControls();
    }

    function syncMarginControls() {
      const marginInput = document.getElementById('margin-goal');
      const marginSlider = document.getElementById('margin-goal-slider');
      const marginDisplay = document.getElementById('margin-display');
      const currentMargin = Number(state.marginGoal || 0);
      if (marginInput) {
        marginInput.value = currentMargin;
      }
      if (marginSlider) {
        marginSlider.value = currentMargin;
      }
      if (marginDisplay) {
        marginDisplay.textContent = `${currentMargin}%`;
      }
    }

    function bindSummaryControls() {
      const marginInput = document.getElementById('margin-goal');
      const marginSlider = document.getElementById('margin-goal-slider');
      const marginDisplay = document.getElementById('margin-display');
      syncMarginControls();

      function updateMargin(value) {
        const sanitized = Math.min(90, Math.max(0, Number(value) || 0));
        state.marginGoal = sanitized;
        if (marginInput) {
          marginInput.value = sanitized;
        }
        if (marginSlider) {
          marginSlider.value = sanitized;
        }
        if (marginDisplay) {
          marginDisplay.textContent = `${sanitized}%`;
        }
        saveState();
        recalc();
      }

      marginInput?.addEventListener('change', () => {
        updateMargin(marginInput.value);
      });

      marginSlider?.addEventListener('input', () => {
        updateMargin(marginSlider.value);
      });
    }

    function calculateModifiers(targetState = state) {
      const details = targetState?.details || defaultState.details;
      const rawQuarter = Number(details.quarter);
      const quarterIndex = Math.min(
        Math.max(Number.isFinite(rawQuarter) && rawQuarter >= 1 ? rawQuarter : 1, 1),
        QUARTER_LABELS.length,
      );
      const rawExcitement = Number(details.brandExcitement);
      const excitementIndex = Math.min(
        Math.max(Number.isFinite(rawExcitement) ? rawExcitement : 1, 0),
        BRAND_EXCITEMENT.length - 1,
      );
      let feeMultiplier = 1;
      if (quarterIndex === 4) {
        feeMultiplier *= 1.15;
      }
      feeMultiplier *= BRAND_EXCITEMENT[excitementIndex]?.multiplier ?? 1;
      if (details.rush) {
        feeMultiplier *= 1.15;
      }
      if (details.travelNeeded) {
        feeMultiplier *= 1.2;
      }
      if (details.nicheCreators) {
        feeMultiplier *= 1.2;
      }
      return {
        feeMultiplier,
        organicViewMultiplier: 1,
        travelRequired: !!details.travelNeeded,
        quarterIndex,
        excitementIndex,
      };
    }

    function recalc() {
      const modifiers = calculateModifiers();
      const contentLines = state.campaignLines.map(line => {
        const total = calculateLineTotal(line);
        return {
          ...line,
          total,
          cogsPerCreator: line.cogsPerCreator || 0,
          cpvWithWhitelist: Number.isFinite(line.cpvWithWhitelist) ? line.cpvWithWhitelist : line.unitRate || 0,
        };
      });
      const platformBudget = {};
      const sizeBudget = {};
      const languageBudget = {};
      const verticalBudget = {};
      const sizeContentPieces = {};
      contentLines.forEach(line => {
        const lineTotal = line.total || 0;
        if (lineTotal > 0) {
          const adjusted = lineTotal * modifiers.feeMultiplier;
          const languageKey = line.language || 'Unspecified';
          const verticalKey = line.vertical || 'Unspecified';
          platformBudget[line.platform] = (platformBudget[line.platform] || 0) + adjusted;
          sizeBudget[line.size] = (sizeBudget[line.size] || 0) + adjusted;
          languageBudget[languageKey] = (languageBudget[languageKey] || 0) + adjusted;
          verticalBudget[verticalKey] = (verticalBudget[verticalKey] || 0) + adjusted;
        }
      });
      const contentSubtotal = contentLines.reduce((acc, line) => acc + line.total, 0);
      const organicViewsRaw = state.campaignLines.reduce((acc, line) => {
        const lineViews = (line.viewsPerPiece || 0) * (line.qtyPerCreator || 0) * (line.creators || 0);
        return acc + lineViews;
      }, 0);
      const organicViewsAdjusted = organicViewsRaw * modifiers.organicViewMultiplier;

      const platformViews = {};
      let totalEstimatedFollowers = 0;
      state.campaignLines.forEach(line => {
        const lineViews = (line.viewsPerPiece || 0)
          * (line.qtyPerCreator || 0)
          * (line.creators || 0)
          * modifiers.organicViewMultiplier;
        if (!platformViews[line.platform]) platformViews[line.platform] = 0;
        platformViews[line.platform] += lineViews;
        const avgFollowers = SIZE_FOLLOWERS[line.size] || 0;
        totalEstimatedFollowers += avgFollowers * (line.creators || 0);
        const pieces = (line.qtyPerCreator || 0) * (line.creators || 0);
        if (pieces > 0) {
          const sizeKey = line.size || 'Unspecified';
          sizeContentPieces[sizeKey] = (sizeContentPieces[sizeKey] || 0) + pieces;
        }
      });

      const feeAdjustedContent = contentSubtotal * modifiers.feeMultiplier;
      const otherBase = (state.otherCosts.other || 0) + (state.otherCosts.study || 0) + (state.otherCosts.additional || 0);
      const otherTotal = otherBase;
      const travelCost = modifiers.travelRequired
        ? (state.travel.creators || 0) * (state.travel.perCreator || 0)
        : 0;

      const paidBudget = state.paidMedia.budget || 0;
      const paidViews = calculatePaidViews(state.paidMedia);
      const baseCOGs = feeAdjustedContent + otherTotal + travelCost;
      const totalCOGs = baseCOGs + paidBudget;
      const marginGoalPct = (state.marginGoal || 0) / 100;
      const markupMultiplier = marginGoalPct >= 1 ? 1 : 1 / (1 - marginGoalPct);
      const totalPriceExcludingPaid = baseCOGs * markupMultiplier;
      const totalPrice = totalPriceExcludingPaid + paidBudget;
      const grossMargin = totalPrice - totalCOGs;
      const priceMultiplier = baseCOGs > 0 ? totalPriceExcludingPaid / baseCOGs : 1;
      contentLines.forEach(line => {
        const baseCpv = Number.isFinite(line.cpvWithWhitelist) ? line.cpvWithWhitelist : line.unitRate || 0;
        const cogsCpv = baseCpv * (modifiers.feeMultiplier ?? 1);
        line.cogsCpv = Number.isFinite(cogsCpv) ? cogsCpv : 0;
        const effectiveCpv = line.cogsCpv * priceMultiplier;
        line.effectiveCpv = Number.isFinite(effectiveCpv) ? effectiveCpv : 0;
      });
      const influencerCogs = feeAdjustedContent;
      const influencerMargin = influencerCogs * Math.max(priceMultiplier - 1, 0);
      const influencerClientCost = influencerCogs + influencerMargin;
      const paidMediaWithMargin = paidBudget;
      const totalContentPieces = state.campaignLines.reduce((acc, line) => acc + (line.qtyPerCreator || 0) * (line.creators || 0), 0);
      const totalCreators = state.campaignLines.reduce((acc, line) => acc + (line.creators || 0), 0);
      const totalCogsPerCreator = totalCreators > 0 ? totalCOGs / totalCreators : 0;
      const pricePerCreator = totalCreators > 0 ? totalPrice / totalCreators : 0;
      const totalViews = organicViewsAdjusted + paidViews;
      const brandCPM = totalViews > 0 ? (totalPrice / totalViews) * 1000 : 0;
      const brandOrganicCPV = organicViewsAdjusted > 0 ? influencerClientCost / organicViewsAdjusted : 0;
      const brandCombinedCPV = totalViews > 0 ? totalPrice / totalViews : 0;
      const adRateCpv = organicViewsAdjusted > 0 ? feeAdjustedContent / organicViewsAdjusted : 0;

      updateSummary({
        contentSubtotal,
        feeAdjustedContent,
        organicViewsRaw,
        organicViewsAdjusted,
        otherTotal,
        travelCost,
        paidBudget,
        influencerClientCost,
        influencerMargin,
        influencerCogs,
        paidMediaWithMargin,
        paidViews,
        totalCOGs,
        totalPrice,
        grossMargin,
        totalContentPieces,
        totalCreators,
        totalCogsPerCreator,
        pricePerCreator,
        brandCPM,
        brandOrganicCPV,
        brandCombinedCPV,
        totalViews,
        platformViews,
        totalEstimatedFollowers,
        adRateCpv,
        modifiers,
        details: state.details,
      });

      const viewMix = {
        'Organic Views': organicViewsAdjusted,
        'Paid Views': paidViews,
      };

      const investmentMix = {
        'Influencer Cost to Client': influencerClientCost,
        'Paid Media Budget (Including Margin)': paidMediaWithMargin,
      };

      updateCharts(
        platformBudget,
        sizeBudget,
        platformViews,
        viewMix,
        investmentMix,
        sizeContentPieces,
        verticalBudget,
        languageBudget,
      );
      updateLineTotals(contentLines);
      saveState();
    }

    function calculatePaidViews(sourcePaidMedia = state.paidMedia) {
      const media = sourcePaidMedia || {};
      const { mode, budget, rate } = media;
      if (!rate || rate <= 0) return 0;
      if (mode === 'cpm') {
        return (budget || 0) / rate * 1000;
      }
      return (budget || 0) / rate;
    }

    function updateSummary(data) {
      const costGrid = document.getElementById('cost-summary');
      const metricsGrid = document.getElementById('summary-grid');
      const budgetStatusCard = document.getElementById('budget-status');

      if (costGrid) {
        costGrid.innerHTML = '';
        const costItems = [
          ['Total COGs', formatCurrency(data.totalCOGs)],
          ['Total Influencer COGs', formatCurrency(data.influencerCogs)],
          ['Influencer Margin', formatCurrency(data.influencerMargin)],
          ['Total Influencer Cost to Client', formatCurrency(data.influencerClientCost)],
          ['Paid Media Budget (Including Margin)', formatCurrency(data.paidMediaWithMargin)],
          ['Total Campaign Budget', formatCurrency(data.totalPrice)],
        ];
        appendSummaryRows(costGrid, costItems);
      }

      if (metricsGrid) {
        metricsGrid.innerHTML = '';
        const metricItems = [
          ['Organic Views (adj.)', data.organicViewsAdjusted],
          ['Paid Views', data.paidViews],
          ['Total Estimated Views', data.totalViews],
          ['Total Content Pieces', data.totalContentPieces],
          ['Total Creators', data.totalCreators],
          ['Min Estimated Followers', data.totalEstimatedFollowers],
          ['Brand CPM', isFinite(data.brandCPM) ? `$${data.brandCPM.toFixed(2)}` : '$0.00'],
          ['Brand Organic CPV', isFinite(data.brandOrganicCPV) ? `$${data.brandOrganicCPV.toFixed(2)}` : '$0.00'],
          ['Brand Combined CPV', isFinite(data.brandCombinedCPV) ? `$${data.brandCombinedCPV.toFixed(2)}` : '$0.00'],
        ];
        appendSummaryRows(metricsGrid, metricItems);
      }

      if (budgetStatusCard) {
        const targetBudget = parseCurrencyInput(data.details?.budget);
        const valueEl = budgetStatusCard.querySelector('.budget-status-value');
        const titleEl = budgetStatusCard.querySelector('.budget-status-title');
        const subtextEl = budgetStatusCard.querySelector('.budget-status-subtext');

        if (targetBudget > 0) {
          const difference = targetBudget - data.totalPrice;
          const differenceAbs = Math.abs(difference);
          const tolerance = Math.max(1, targetBudget * 0.001);
          const differenceRatio = targetBudget ? difference / targetBudget : 0;
          const targetVsEstimate = `Target ${formatCurrency(targetBudget)} vs Est. ${formatCurrency(data.totalPrice)}`;
          if (data.totalPrice > targetBudget && differenceAbs > tolerance) {
            budgetStatusCard.className = 'budget-status-card budget-status-over';
            if (titleEl) titleEl.textContent = 'Over Budget';
            if (valueEl) valueEl.textContent = `${formatCurrency(differenceAbs)} over target`;
          } else if (differenceRatio >= 0.1) {
            budgetStatusCard.className = 'budget-status-card budget-status-under';
            if (titleEl) titleEl.textContent = 'Significantly Under Budget';
            if (valueEl) valueEl.textContent = `${formatCurrency(difference)} remaining`;
          } else if (Math.abs(difference) <= tolerance) {
            budgetStatusCard.className = 'budget-status-card budget-status-good';
            if (titleEl) titleEl.textContent = 'On Budget';
            if (valueEl) valueEl.textContent = 'Spending matches the target.';
          } else {
            budgetStatusCard.className = 'budget-status-card budget-status-good';
            if (titleEl) titleEl.textContent = 'In Budget';
            if (valueEl) valueEl.textContent = `${formatCurrency(difference)} remaining`;
          }

          if (subtextEl) {
            subtextEl.textContent = targetVsEstimate;
          }
        } else {
          budgetStatusCard.className = 'budget-status-card budget-status-neutral';
          if (titleEl) titleEl.textContent = 'Budget Status';
          if (valueEl) valueEl.textContent = 'No target budget set';
          if (subtextEl) subtextEl.textContent = 'Enter a target budget in campaign details to compare.';
        }
      }

      const status = document.getElementById('status-badge');
      if (status) {
        status.className = 'status-badge status-ok';
        const details = data.details || {};
        const brand = (details.brand || '').trim();
        const campaign = (details.campaignName || '').trim();
        const budget = (details.budget || '').trim();
        const quarterLabel = QUARTER_LABELS[(data.modifiers?.quarterIndex ?? 1) - 1] ?? 'Q1';
        const excitementLabel = BRAND_EXCITEMENT[data.modifiers?.excitementIndex ?? 1]?.label ?? 'Neutral';
        const meta = [];
        if (brand) meta.push(brand);
        if (campaign) meta.push(campaign);
        if (budget) meta.push(`Budget ${budget}`);
        meta.push(`Quarter ${quarterLabel}`);
        meta.push(`Excitement ${excitementLabel}`);
        status.textContent = meta.join(' • ');
      }

      const breakdown = document.getElementById('platform-breakdown');
      breakdown.innerHTML = '<strong style="color:#cbd5f5; font-size:0.85rem;">Platform View Share</strong>';
      const total = Object.values(data.platformViews).reduce((acc, v) => acc + v, 0) || 1;
      Object.entries(data.platformViews).forEach(([platform, views]) => {
        const row = document.createElement('div');
        const pct = ((views / total) * 100).toFixed(1);
        row.innerHTML = `<span>${platform}</span><span>${formatNumber(views)} (${pct}%)</span>`;
        breakdown.appendChild(row);
      });
    }

    function appendSummaryRows(container, items) {
      items.forEach(([label, value]) => {
        const row = document.createElement('div');
        row.className = 'summary-item';
        const labelSpan = document.createElement('span');
        labelSpan.textContent = label;
        const valueSpan = document.createElement('span');
        if (typeof value === 'number' && !label.toLowerCase().includes('cpm')) {
          valueSpan.textContent = formatNumber(value);
        } else {
          valueSpan.textContent = value;
        }
        row.appendChild(labelSpan);
        row.appendChild(valueSpan);
        container.appendChild(row);
      });
    }

    function parseCurrencyInput(value) {
      if (value === null || value === undefined) return 0;
      if (typeof value === 'number' && Number.isFinite(value)) return value;
      const sanitized = String(value).replace(/[^0-9.-]+/g, '');
      const parsed = parseFloat(sanitized);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function updateCharts(
      platformBudget,
      sizeBudget,
      platformViews,
      viewMix,
      investmentMix,
      contentPiecesBySize,
      verticalBudget,
      languageBudget,
    ) {
      const percentageOptions = {
        decimals: 1,
        toPercentage: true,
        tooltipLabelFormatter: defaultPercentTooltipFormatter,
        datasetLabel: 'Percent of Budget',
        valueSuffix: '%',
        maxValue: 100,
      };
      updateChart(chartStates.platformBudget, platformBudget, percentageOptions);
      updateChart(chartStates.languageBudget, languageBudget, percentageOptions);
      updateChart(chartStates.sizeBudget, sizeBudget, percentageOptions);
      updateChart(chartStates.verticalBudget, verticalBudget, percentageOptions);
      updateChart(chartStates.platformViews, platformViews, {
        decimals: 0,
        tooltipLabelFormatter: createViewTooltipFormatter('views'),
      });
      updateChart(chartStates.sizeContent, contentPiecesBySize, {
        decimals: 0,
        tooltipLabelFormatter: createCountTooltipFormatter('pieces'),
        datasetLabel: 'Content Pieces',
      });
      updateChart(chartStates.viewMix, viewMix, {
        decimals: 0,
        tooltipLabelFormatter: createViewTooltipFormatter('views'),
      });
      updateChart(chartStates.investmentMix, investmentMix);
    }

    function prepareChartData(source, options = {}) {
      const { decimals = 2, toPercentage = false } = options;
      const entries = Object.entries(source || {}).filter(([, value]) => value > 0);
      if (!entries.length) {
        return { labels: ['No Data'], values: [1] };
      }
      entries.sort((a, b) => b[1] - a[1]);
      const labels = entries.map(([label]) => label);
      const total = entries.reduce((acc, [, value]) => acc + value, 0) || 1;
      const values = entries.map(([, value]) => {
        const finalValue = toPercentage ? (value / total) * 100 : value;
        return Number(finalValue.toFixed(decimals));
      });
      return { labels, values };
    }

    function updateChart(state, source, options = {}) {
      const ctx = document.getElementById(state.canvasId)?.getContext('2d');
      if (!ctx) return;
      state.ctx = ctx;
      const data = prepareChartData(source, options);
      state.lastData = data;
      state.chartOptions = options;
      if (options.tooltipLabelFormatter) {
        state.tooltipLabelFormatter = options.tooltipLabelFormatter;
      } else if (!state.tooltipLabelFormatter) {
        state.tooltipLabelFormatter = defaultCurrencyTooltipFormatter;
      }
      renderChartInstance(state, data, options);
    }

    function renderChartInstance(state, data, options = {}) {
      if (!state.ctx) return;
      if (state.instance) {
        state.instance.destroy();
      }
      const chartConfig = createChartConfig(
        state.currentType,
        data,
        state.tooltipLabelFormatter,
        options
      );
      state.instance = new Chart(state.ctx, chartConfig);
      const canvas = state.instance.canvas;
      if (canvas) {
        canvas.style.cursor = 'pointer';
        const nextType = state.currentType === 'pie' ? 'bar' : 'pie';
        canvas.title = `Click to switch to ${nextType} chart`;
        if (!state.listenerAttached) {
          canvas.addEventListener('click', () => toggleChartType(state));
          state.listenerAttached = true;
        }
      }
    }

    function toggleChartType(state) {
      state.currentType = state.currentType === state.defaultType ? state.alternateType : state.defaultType;
      if (state.lastData) {
        renderChartInstance(state, state.lastData, state.chartOptions || {});
      }
    }

    function createChartConfig(
      type,
      data,
      tooltipLabelFormatter = defaultCurrencyTooltipFormatter,
      options = {}
    ) {
      const palette = ['#38bdf8', '#818cf8', '#f472b6', '#facc15', '#34d399', '#fb7185', '#fbbf24', '#a855f7'];
      const backgroundColor = data.labels.map((_, idx) => palette[idx % palette.length]);
      const dataset = {
        data: data.values,
        backgroundColor,
        borderColor: '#0f172a',
        borderWidth: type === 'pie' ? 2 : 1,
        label: options.datasetLabel || 'Value',
      };
      const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: type === 'pie' ? 'bottom' : 'top',
            display: type === 'pie',
            labels: {
              color: '#cbd5f5',
            },
          },
          tooltip: {
            callbacks: {
              label(context) {
                if (context.label === 'No Data') {
                  return 'No Data';
                }
                const value = context.raw || 0;
                const total = data.values.reduce((acc, v) => acc + v, 0) || 1;
                return tooltipLabelFormatter(context.label, value, total);
              },
            },
          },
        },
      };

      if (type === 'bar') {
        baseOptions.scales = {
          x: {
            beginAtZero: true,
            ticks: {
              color: '#cbd5f5',
            },
            grid: {
              color: '#334155',
            },
          },
          y: {
            beginAtZero: true,
            ticks: {
              color: '#cbd5f5',
              callback(value) {
                if (options.valueSuffix) {
                  return `${value}${options.valueSuffix}`;
                }
                return value;
              },
            },
            grid: {
              display: false,
              color: '#1e293b',
            },
          },
        };
        if (options.maxValue) {
          baseOptions.scales.y.max = options.maxValue;
        }
      }

      return {
        type,
        data: {
          labels: data.labels,
          datasets: [dataset],
        },
        options: baseOptions,
      };
    }

    function createChartState(canvasId, tooltipLabelFormatter = defaultCurrencyTooltipFormatter) {
      return {
        canvasId,
        instance: null,
        ctx: null,
        defaultType: 'pie',
        alternateType: 'bar',
        currentType: 'pie',
        tooltipLabelFormatter,
        lastData: null,
        listenerAttached: false,
        chartOptions: {},
      };
    }

    function defaultCurrencyTooltipFormatter(label, value, total) {
      const pct = ((value / total) * 100).toFixed(1);
      return `${label}: $${formatNumber(value)} (${pct}%)`;
    }

    function defaultPercentTooltipFormatter(label, value, total) {
      const pct = ((value / total) * 100).toFixed(1);
      return `${label}: ${pct}%`;
    }

    function createViewTooltipFormatter(unit) {
      return (label, value, total) => {
        const pct = ((value / total) * 100).toFixed(1);
        return `${label}: ${formatNumber(value)} ${unit} (${pct}%)`;
      };
    }

    function createCountTooltipFormatter(unit) {
      return (label, value, total) => {
        const pct = ((value / total) * 100).toFixed(1);
        const unitLabel = unit ? ` ${unit}` : '';
        return `${label}: ${formatNumber(value)}${unitLabel} (${pct}%)`;
      };
    }

    function updateLineTotals(contentLines) {
      const rows = document.querySelectorAll('#campaign-body tr');
      contentLines.forEach((line, idx) => {
        const row = rows[idx];
        if (!row) return;
        const viewsCell = row.children?.[8];
        const viewDisplay = viewsCell?.querySelector('.readonly-value');
        if (viewDisplay) {
          viewDisplay.textContent = formatNumber(line.viewsPerPiece || 0);
        }
        const cogsCpvDisplay = row.querySelector('.cogs-cpv');
        if (cogsCpvDisplay) {
          const cogsValue = Number.isFinite(line.cogsCpv)
            ? line.cogsCpv
            : Number.isFinite(line.cpvWithWhitelist)
              ? line.cpvWithWhitelist
              : line.unitRate || 0;
          cogsCpvDisplay.textContent = formatCpv(cogsValue);
        }
        const clientCpvDisplay = row.querySelector('.client-cpv');
        if (clientCpvDisplay) {
          const cpvValue = Number.isFinite(line.effectiveCpv)
            ? line.effectiveCpv
            : Number.isFinite(line.cogsCpv)
              ? line.cogsCpv
              : Number.isFinite(line.cpvWithWhitelist)
                ? line.cpvWithWhitelist
                : line.unitRate || 0;
          clientCpvDisplay.textContent = formatCpv(cpvValue);
        }
        const totalCell = row.children?.[11];
        if (totalCell) {
          totalCell.textContent = formatCurrency(line.total);
        }
      });
    }

    function formatCurrency(value) {
      return `$${formatNumber(value)}`;
    }

    function formatCpv(value) {
      if (!isFinite(value) || value <= 0) return '$0.000';
      return `$${value.toFixed(3)}`;
    }

    function formatNumber(value) {
      if (!isFinite(value)) return '0';
      return Number(value).toLocaleString('en-US', { maximumFractionDigits: 0 });
    }

    function cloneValue(value) {
      if (typeof structuredClone === 'function') {
        try {
          return structuredClone(value);
        } catch (err) {
          console.warn('structuredClone failed, falling back to JSON clone', err);
        }
      }
      return JSON.parse(JSON.stringify(value));
    }

    function toCsvNumber(value, decimals = 2) {
      if (!Number.isFinite(value)) return '0';
      return Number(value).toFixed(decimals);
    }

    function sanitizeCsvValue(value) {
      if (value === null || value === undefined) {
        return '';
      }
      if (typeof value === 'number') {
        if (!Number.isFinite(value)) return '0';
        return String(value);
      }
      const str = String(value);
      if (/[",\n]/.test(str)) {
        return `"${str.replace(/"/g, '""')}"`;
      }
      return str;
    }

    function buildCsv(rows) {
      return rows.map(row => row.map(sanitizeCsvValue).join(',')).join('\n');
    }

    function createCampaignFileName(name) {
      const fallback = 'pic-campaign';
      if (!name) return `${fallback}.csv`;
      const safe = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
      return `${safe || fallback}.csv`;
    }

    function triggerCsvDownload(filename, csvContent) {
      if (!csvContent) return;
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const anchor = document.createElement('a');
      anchor.href = url;
      anchor.download = filename;
      anchor.style.display = 'none';
      document.body.appendChild(anchor);
      anchor.click();
      document.body.removeChild(anchor);
      URL.revokeObjectURL(url);
    }

    // Collate campaign selections into a CSV export for quick sharing.
    function exportCampaignToCSV(campaignRecord) {
      const sourceRecord = campaignRecord || null;
      const campaignName = sourceRecord?.name || state?.details?.campaignName || 'Campaign';
      const brandName = sourceRecord?.brand || state?.details?.brand || '';
      const rawState = sourceRecord?.data ? cloneValue(sourceRecord.data) : cloneValue(state);
      const normalized = normalizeCampaignState(rawState);
      const summaryRecord = createCampaignRecord(normalized, sourceRecord?.id, campaignName);
      const modifiers = calculateModifiers(normalized);
      const marginGoalPct = (normalized.marginGoal || 0) / 100;
      const markupMultiplier = marginGoalPct >= 1 ? 1 : 1 / (1 - marginGoalPct);
      const headers = [
        'Campaign',
        'Brand',
        'Platform',
        'Deliverable',
        'Vertical',
        'Language',
        'Creator Size',
        'Creators',
        'Content Each',
        'Total Content Pieces',
        'Views per Piece',
        'Estimated Views',
        'COGS CPV ($)',
        'Client CPV ($)',
        'Total COGS ($)',
        'Client Total ($)',
        'Client CPM ($)',
      ];
      const rows = [headers];
      let totalEstimatedViews = 0;
      let totalCogs = 0;
      let totalClient = 0;
      let totalCreators = 0;
      let totalPieces = 0;
      (normalized.campaignLines || []).forEach(line => {
        const working = { ...createDefaultLine(), ...cloneValue(line) };
        applyLineDefaults(working, { forceViews: true });
        const lineTotal = calculateLineTotal(working);
        const cogsTotal = lineTotal * (modifiers.feeMultiplier ?? 1);
        const clientTotal = cogsTotal * markupMultiplier;
        const creators = Number(working.creators || 0);
        const contentEach = Number(working.qtyPerCreator || 0);
        const totalContent = creators * contentEach;
        const baseViewsPerPiece = Number(working.viewsPerPiece || 0);
        const estimatedViews = baseViewsPerPiece * totalContent * (modifiers.organicViewMultiplier ?? 1);
        const cpvBase = Number.isFinite(working.cpvWithWhitelist)
          ? working.cpvWithWhitelist
          : working.unitRate || 0;
        const cogsCpv = cpvBase * (modifiers.feeMultiplier ?? 1);
        const clientCpv = cogsCpv * markupMultiplier;
        const clientCpm = estimatedViews > 0 ? (clientTotal / estimatedViews) * 1000 : 0;
        totalEstimatedViews += estimatedViews;
        totalCogs += cogsTotal;
        totalClient += clientTotal;
        totalCreators += creators;
        totalPieces += totalContent;
        rows.push([
          summaryRecord.name,
          brandName,
          working.platform,
          working.deliverable,
          working.vertical,
          working.language,
          working.size,
          String(creators),
          String(contentEach),
          String(totalContent),
          String(baseViewsPerPiece),
          String(Math.round(estimatedViews)),
          toCsvNumber(cogsCpv, 3),
          toCsvNumber(clientCpv, 3),
          toCsvNumber(cogsTotal, 2),
          toCsvNumber(clientTotal, 2),
          toCsvNumber(clientCpm, 2),
        ]);
      });
      if (rows.length === 1) {
        rows.push([
          summaryRecord.name,
          brandName,
          '—',
          '—',
          '—',
          '—',
          '—',
          '0',
          '0',
          '0',
          '0',
          '0',
          '0',
          '0',
          '0',
          '0',
          '0',
        ]);
      }
      const totalCpvCogs = totalEstimatedViews > 0 ? totalCogs / totalEstimatedViews : 0;
      const totalCpvClient = totalEstimatedViews > 0 ? totalClient / totalEstimatedViews : 0;
      const totalCpmClient = totalEstimatedViews > 0 ? (totalClient / totalEstimatedViews) * 1000 : 0;
      rows.push([
        `${summaryRecord.name} (Total)`,
        brandName,
        'All',
        'All',
        '—',
        '—',
        'All Sizes',
        String(totalCreators),
        '',
        String(totalPieces),
        '',
        String(Math.round(totalEstimatedViews)),
        toCsvNumber(totalCpvCogs, 3),
        toCsvNumber(totalCpvClient, 3),
        toCsvNumber(totalCogs, 2),
        toCsvNumber(totalClient, 2),
        toCsvNumber(totalCpmClient, 2),
      ]);
      const csvContent = buildCsv(rows);
      triggerCsvDownload(createCampaignFileName(summaryRecord.name), csvContent);
    }

    const hasReact = typeof React !== 'undefined' && typeof ReactDOM !== 'undefined';
    const { useState, useEffect, useMemo, useCallback, useRef } = hasReact ? React : {};
    const h = hasReact ? React.createElement : () => null;

    const AUTH_STATUS = {
      LOADING: 'loading',
      AUTHENTICATED: 'authenticated',
      GUEST: 'guest',
    };

    const AuthContext = hasReact ? React.createContext(null) : null;

    function useAuth() {
      if (!hasReact || !AuthContext) {
        return {};
      }
      const context = React.useContext(AuthContext);
      if (!context) {
        throw new Error('useAuth must be used within an AuthProvider');
      }
      return context;
    }

    function parseErrorMessage(response, fallback) {
      if (!response) return fallback;
      try {
        return response.message || fallback;
      } catch (err) {
        return fallback;
      }
    }

    function AuthProvider({ children }) {
      if (!hasReact) return null;
      const [user, setUser] = useState(null);
      const [status, setStatus] = useState(AUTH_STATUS.LOADING);
      const [accessToken, setAccessToken] = useState(null);

      const applyAuthSuccess = useCallback(payload => {
        if (!payload) return;
        setUser(payload.user || null);
        setAccessToken(payload.accessToken || null);
        setStatus(AUTH_STATUS.AUTHENTICATED);
      }, []);

      const clearSession = useCallback(() => {
        setUser(null);
        setAccessToken(null);
        setStatus(AUTH_STATUS.GUEST);
      }, []);

      const refreshAccessToken = useCallback(async () => {
        try {
          const response = await fetch('/api/token/refresh', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
          });
          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(parseErrorMessage(payload, 'Session expired.'));
          }
          applyAuthSuccess(payload);
          return payload.accessToken;
        } catch (err) {
          clearSession();
          throw err;
        }
      }, [applyAuthSuccess, clearSession]);

      const login = useCallback(async (email, password) => {
        const response = await fetch('/api/login', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(parseErrorMessage(payload, 'Unable to log in.'));
        }
        applyAuthSuccess(payload);
        return payload.user;
      }, [applyAuthSuccess]);

      const register = useCallback(async (email, password) => {
        const response = await fetch('/api/register', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(parseErrorMessage(payload, 'Unable to register.'));
        }
        applyAuthSuccess(payload);
        return payload.user;
      }, [applyAuthSuccess]);

      const logout = useCallback(async () => {
        try {
          await fetch('/api/logout', { method: 'POST', credentials: 'include' });
        } catch (err) {
          console.warn('Logout request failed', err);
        }
        clearSession();
      }, [clearSession]);

      useEffect(() => {
        let cancelled = false;
        refreshAccessToken().catch(() => {
          if (!cancelled) {
            clearSession();
          }
        });
        return () => {
          cancelled = true;
        };
      }, [refreshAccessToken, clearSession]);

      const value = useMemo(() => ({
        user,
        status,
        accessToken,
        login,
        register,
        logout,
        refreshAccessToken,
      }), [user, status, accessToken, login, register, logout, refreshAccessToken]);

      return h(AuthContext.Provider, { value }, children);
    }

    function AuthGate({ mode, onModeChange }) {
      const activeMode = mode === 'register' ? 'register' : 'login';
      const heading = activeMode === 'register'
        ? 'Create your PIC account'
        : 'Welcome back to PIC';
      const description = activeMode === 'register'
        ? 'Set up a secure account to save campaigns and export pricing snapshots.'
        : 'Sign in to access your influencer campaigns and pricing insights.';
      return h('div', { className: 'auth-container' },
        h('div', { className: 'auth-card' },
          h('div', null,
            h('h2', null, heading),
            h('p', null, description),
          ),
          activeMode === 'register'
            ? h(RegisterForm, { onSwitch: () => onModeChange('login') })
            : h(LoginForm, { onSwitch: () => onModeChange('register') }),
        ),
      );
    }

    function LoginForm({ onSwitch }) {
      const { login } = useAuth();
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [submitting, setSubmitting] = useState(false);

      const handleSubmit = async event => {
        event.preventDefault();
        setError('');
        const trimmedEmail = email.trim();
        if (!/^\S+@\S+\.\S+$/.test(trimmedEmail)) {
          setError('Enter a valid email address.');
          return;
        }
        if (!password || password.length < 8) {
          setError('Password must be at least 8 characters.');
          return;
        }
        setSubmitting(true);
        try {
          await login(trimmedEmail.toLowerCase(), password);
        } catch (err) {
          setError(err.message || 'Unable to log in.');
        } finally {
          setSubmitting(false);
        }
      };

      return h('form', { className: 'auth-form', onSubmit: handleSubmit, autoComplete: 'on' },
        h('label', { htmlFor: 'login-email' },
          h('span', null, 'Email'),
          h('input', {
            id: 'login-email',
            type: 'email',
            required: true,
            value: email,
            onChange: event => setEmail(event.target.value),
            autoComplete: 'email',
          }),
        ),
        h('label', { htmlFor: 'login-password' },
          h('span', null, 'Password'),
          h('input', {
            id: 'login-password',
            type: 'password',
            required: true,
            minLength: 8,
            value: password,
            onChange: event => setPassword(event.target.value),
            autoComplete: 'current-password',
          }),
        ),
        error ? h('div', { className: 'auth-error' }, error) : null,
        h('div', { className: 'auth-actions' },
          h('button', { type: 'submit', disabled: submitting }, submitting ? 'Signing in…' : 'Sign In'),
          h('button', { type: 'button', className: 'auth-switch', onClick: onSwitch }, 'Create account'),
        ),
        h('div', { className: 'auth-meta' }, 'Use the email issued by your organisation for access.'),
      );
    }

    function RegisterForm({ onSwitch }) {
      const { register } = useAuth();
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [error, setError] = useState('');
      const [submitting, setSubmitting] = useState(false);

      const handleSubmit = async event => {
        event.preventDefault();
        setError('');
        const trimmedEmail = email.trim();
        if (!/^\S+@\S+\.\S+$/.test(trimmedEmail)) {
          setError('Enter a valid email address.');
          return;
        }
        if (!password || password.length < 8) {
          setError('Password must be at least 8 characters.');
          return;
        }
        if (password !== confirmPassword) {
          setError('Passwords do not match.');
          return;
        }
        setSubmitting(true);
        try {
          await register(trimmedEmail.toLowerCase(), password);
        } catch (err) {
          setError(err.message || 'Unable to register.');
        } finally {
          setSubmitting(false);
        }
      };

      return h('form', { className: 'auth-form', onSubmit: handleSubmit, autoComplete: 'on' },
        h('label', { htmlFor: 'register-email' },
          h('span', null, 'Work email'),
          h('input', {
            id: 'register-email',
            type: 'email',
            required: true,
            value: email,
            onChange: event => setEmail(event.target.value),
            autoComplete: 'email',
          }),
        ),
        h('label', { htmlFor: 'register-password' },
          h('span', null, 'Password'),
          h('input', {
            id: 'register-password',
            type: 'password',
            required: true,
            minLength: 8,
            value: password,
            onChange: event => setPassword(event.target.value),
            autoComplete: 'new-password',
          }),
        ),
        h('label', { htmlFor: 'register-confirm' },
          h('span', null, 'Confirm password'),
          h('input', {
            id: 'register-confirm',
            type: 'password',
            required: true,
            minLength: 8,
            value: confirmPassword,
            onChange: event => setConfirmPassword(event.target.value),
            autoComplete: 'new-password',
          }),
        ),
        error ? h('div', { className: 'auth-error' }, error) : null,
        h('div', { className: 'auth-actions' },
          h('button', { type: 'submit', disabled: submitting }, submitting ? 'Creating account…' : 'Register'),
          h('button', { type: 'button', className: 'auth-switch', onClick: onSwitch }, 'Back to sign in'),
        ),
        h('div', { className: 'auth-meta' }, 'Passwords are hashed and stored securely using bcrypt.'),
      );
    }

    function PricingVariablesMenu({ onClose }) {
      const [showAdvanced, setShowAdvanced] = useState(false);

      const platformRows = useMemo(() => {
        const entries = [];
        Object.entries(pricingVariables.rateCard).forEach(([platform, detail]) => {
          Object.entries(detail.deliverables || {}).forEach(([deliverable, spec]) => {
            const viewsBySize = spec.viewsBySize
              ? Object.entries(spec.viewsBySize)
                  .map(([size, value]) => `${size}: ${formatNumber(value)}`)
                  .join(' | ')
              : `Macro baseline: ${formatNumber(spec.baseViews || 0)}`;
            const verticalRates = spec.cpvByVertical
              ? Object.entries(spec.cpvByVertical)
                  .map(([key, value]) => `${key}: $${Number(value).toFixed(3)}`)
                  .join(' | ')
              : null;
            entries.push({
              key: `${platform}-${deliverable}`,
              label: `${platform} • ${deliverable}`,
              cpv: Number(spec.cpv || 0),
              baseViews: spec.baseViews || 0,
              viewsBySize,
              verticalRates,
            });
          });
        });
        return entries;
      }, []);

      const sizeRows = useMemo(() => (
        Object.entries(pricingVariables.sizeMultipliers).map(([size, value]) => ({
          key: size,
          label: size,
          multiplier: value.views || 1,
          followers: pricingVariables.sizeFollowers[size] || null,
        }))
      ), []);

      const verticalRows = useMemo(() => (
        Object.entries(pricingVariables.verticalMultipliers).map(([vertical, value]) => ({
          key: vertical,
          rate: value.rate || 1,
          views: value.views || 1,
        }))
      ), []);

      const languageRows = useMemo(() => (
        Object.entries(pricingVariables.languageMultipliers).map(([language, value]) => ({
          key: language,
          rate: value.rate || 1,
          views: value.views || 1,
        }))
      ), []);

      const whitelistRows = useMemo(() => (
        Object.entries(pricingVariables.whitelistUplift).map(([size, pct]) => ({
          key: size,
          pct,
        }))
      ), []);

      const excitementRows = useMemo(() => (
        pricingVariables.brandExcitement.map(entry => ({
          key: entry.label,
          label: entry.label,
          multiplier: entry.multiplier,
        }))
      ), []);

      const paidMediaRows = useMemo(() => (
        Object.entries(pricingVariables.defaultPaidRates).map(([mode, value]) => ({
          key: mode,
          value,
        }))
      ), []);

      const handleOverlayClick = event => {
        if (event.target === event.currentTarget) {
          onClose();
        }
      };

      return h('div', { className: 'pricing-menu-overlay', onClick: handleOverlayClick },
        h('div', { className: 'pricing-menu', role: 'dialog', 'aria-modal': 'true' },
          h('header', null,
            h('h3', null, 'Pricing Variables'),
            h('div', { className: 'campaign-toolbar-actions' },
              h('button', {
                type: 'button',
                className: 'secondary',
                onClick: () => setShowAdvanced(prev => !prev),
              }, showAdvanced ? 'Hide advanced' : 'Show advanced'),
              h('button', { type: 'button', className: 'secondary', onClick: onClose }, 'Close'),
            ),
          ),
          h('div', { className: 'pricing-section' },
            h('h4', null, 'Platform deliverables'),
            h('div', { className: 'pricing-grid' },
              platformRows.map(row => h('div', { key: row.key, className: 'pricing-grid' },
                h('div', { className: 'pricing-row' },
                  h('span', null, row.label),
                  h('span', null, `$${row.cpv.toFixed(3)} CPV`),
                ),
                h('div', { className: 'pricing-note' }, row.viewsBySize),
                row.verticalRates
                  ? h('div', { className: 'pricing-note' }, `Vertical CPV overrides: ${row.verticalRates}`)
                  : null,
              )),
            ),
          ),
          h('div', { className: 'pricing-section' },
            h('h4', null, 'Creator size assumptions'),
            h('div', { className: 'pricing-grid' },
              sizeRows.map(row => h('div', { key: row.key, className: 'pricing-row' },
                h('span', null, row.label),
                h('span', null, `x${row.multiplier.toFixed(2)} views${row.followers ? ` • ≥ ${formatNumber(row.followers)} followers` : ''}`),
              )),
            ),
          ),
          h('div', { className: 'pricing-section' },
            h('h4', null, 'Vertical & language multipliers'),
            h('div', { className: 'pricing-grid' },
              verticalRows.map(row => h('div', { key: `vertical-${row.key}`, className: 'pricing-row' },
                h('span', null, `${row.key} vertical`),
                h('span', null, `${row.rate.toFixed(2)}x rate • ${row.views.toFixed(2)}x views`),
              )),
              languageRows.map(row => h('div', { key: `language-${row.key}`, className: 'pricing-row' },
                h('span', null, `${row.key} language`),
                h('span', null, `${row.rate.toFixed(2)}x rate • ${row.views.toFixed(2)}x views`),
              )),
            ),
          ),
          h('div', { className: 'pricing-section' },
            h('h4', null, 'Paid media defaults'),
            h('div', { className: 'pricing-grid' },
              paidMediaRows.map(row => h('div', { key: row.key, className: 'pricing-row' },
                h('span', null, row.key.toUpperCase()),
                h('span', null, `$${Number(row.value).toFixed(row.key === 'cpm' ? 2 : 3)}`),
              )),
            ),
          ),
          showAdvanced
            ? h('div', { className: 'pricing-section' },
                h('h4', null, 'Advanced adjustments'),
                h('div', { className: 'pricing-grid' },
                  h('div', { className: 'pricing-row' },
                    h('span', null, 'Rush fee'),
                    h('span', null, `+${(pricingVariables.rushFeePercentage * 100).toFixed(0)}%`),
                  ),
                  h('div', { className: 'pricing-row' },
                    h('span', null, 'Travel fee'),
                    h('span', null, `+${(pricingVariables.travelFeePercentage * 100).toFixed(0)}%`),
                  ),
                  h('div', { className: 'pricing-row' },
                    h('span', null, 'Niche creator premium'),
                    h('span', null, `+${(pricingVariables.nicheFeePercentage * 100).toFixed(0)}%`),
                  ),
                  h('div', { className: 'pricing-row' },
                    h('span', null, 'Q4 uplift'),
                    h('span', null, `+${(pricingVariables.q4FeePercentage * 100).toFixed(0)}%`),
                  ),
                  excitementRows.map(row => h('div', { key: `excitement-${row.key}`, className: 'pricing-row' },
                    h('span', null, `Brand excitement — ${row.label}`),
                    h('span', null, `${row.multiplier.toFixed(2)}x fee multiplier`),
                  )),
                  whitelistRows.map(row => h('div', { key: `whitelist-${row.key}`, className: 'pricing-row' },
                    h('span', null, `Whitelist uplift — ${row.key}`),
                    h('span', null, `+${(row.pct * 100).toFixed(0)}% CPV`),
                  )),
                ),
                h('div', { className: 'pricing-note' }, 'Advanced adjustments are applied automatically when the relevant toggles are enabled in the campaign builder.'),
              )
            : null,
          h('div', { className: 'pricing-note' }, 'Variables are read-only today. Editing controls will unlock once benchmarking workflows are supported.'),
        ),
      );
    }

    let calculatorBootstrapped = false;

    function startCalculator() {
      if (calculatorBootstrapped) return;
      calculatorBootstrapped = true;
      init();
    }

    function AppShell() {
      const { status } = useAuth();
      const [authMode, setAuthMode] = useState('login');

      useEffect(() => {
        if (status === AUTH_STATUS.AUTHENTICATED) {
          document.body.classList.remove('unauthenticated');
          startCalculator();
          try {
            if (window.location.pathname === '/login') {
              window.history.replaceState({}, '', '/');
            }
          } catch (err) {
            console.warn('Failed to update history after login', err);
          }
        } else if (status === AUTH_STATUS.GUEST) {
          document.body.classList.add('unauthenticated');
          try {
            const targetPath = authMode === 'register' ? '/register' : '/login';
            window.history.replaceState({}, '', targetPath);
          } catch (err) {
            console.warn('Failed to update history for login view', err);
          }
        }
      }, [status, authMode]);

      if (status === AUTH_STATUS.LOADING) {
        return h('div', { className: 'auth-loading' }, 'Checking your session…');
      }

      if (status !== AUTH_STATUS.AUTHENTICATED) {
        return h(AuthGate, { mode: authMode, onModeChange: setAuthMode });
      }

      return h(CampaignApp);
    }

    function RootApp() {
      if (!hasReact) return null;
      return h(AuthProvider, null, h(AppShell));
    }
    const BASE_PATH = deriveBasePath();

    function deriveBasePath() {
      const path = window.location.pathname || '';
      if (/\/campaigns\/?$/.test(path)) {
        return path.replace(/\/campaigns\/?$/, '');
      }
      if (/\/campaign\/[^/]+\/?$/.test(path)) {
        return path.replace(/\/campaign\/[^/]+\/?$/, '');
      }
      if (path.endsWith('/index.html')) {
        return path.slice(0, -'/index.html'.length);
      }
      return path !== '/' && path.endsWith('/') ? path.slice(0, -1) : path;
    }

    function buildRoutePath(segment) {
      const base = BASE_PATH && BASE_PATH !== '/' ? BASE_PATH.replace(/\/$/, '') : '';
      if (!segment) {
        return base || '/';
      }
      const normalizedSegment = segment.startsWith('/') ? segment : `/${segment}`;
      const composed = `${base}${normalizedSegment}`;
      return composed || normalizedSegment;
    }

    function parseRoute(campaignList) {
      const list = Array.isArray(campaignList) ? campaignList : [];
      const hash = window.location.hash || '';
      if (hash === '#/campaigns') {
        return { view: 'dashboard', id: null };
      }
      const hashMatch = hash.match(/^#\/campaign\/([^/]+)/);
      if (hashMatch) {
        const hashId = decodeURIComponent(hashMatch[1]);
        if (list.some(campaign => campaign.id === hashId)) {
          return { view: 'editor', id: hashId };
        }
      }
      const path = window.location.pathname || '';
      if (/\/campaigns\/?$/.test(path)) {
        return { view: 'dashboard', id: null };
      }
      const pathMatch = path.match(/\/campaign\/([^/]+)\/?$/);
      if (pathMatch) {
        const pathId = decodeURIComponent(pathMatch[1]);
        if (list.some(campaign => campaign.id === pathId)) {
          return { view: 'editor', id: pathId };
        }
      }
      const fallbackId = list[0]?.id ?? null;
      return { view: fallbackId ? 'editor' : 'dashboard', id: fallbackId };
    }

    function updateRoute(view, campaignId) {
      const targetHash = view === 'dashboard'
        ? '#/campaigns'
        : campaignId
          ? `#/campaign/${campaignId}`
          : '#/campaigns';
      if (window.location.hash !== targetHash) {
        window.location.hash = targetHash;
      }
      const segment = view === 'dashboard'
        ? 'campaigns'
        : campaignId
          ? `campaign/${encodeURIComponent(campaignId)}`
          : 'campaigns';
      const targetPath = buildRoutePath(segment);
      const currentPath = window.location.pathname || '';
      const state = { view, id: campaignId };
      if (currentPath !== targetPath) {
        history.pushState(state, '', targetPath);
      } else {
        history.replaceState(state, '', targetPath);
      }
    }

    function CampaignCard({ campaign, onEdit, onDuplicate, onDelete, onExport }) {
      const budgetDisplay = campaign.budget > 0 ? formatCurrency(campaign.budget) : 'Not set';
      const creatorLabel = formatNumber(campaign.totalCreators || 0);
      const viewLabel = formatNumber(Math.round(campaign.estimatedViews || 0));
      const brandLabel = campaign.brand || 'Brand TBD';
      const quarterLabel = campaign.quarterLabel || 'Timing TBD';
      const deliverables = campaign.deliverableCount || 0;
      const deliverableDisplay = formatNumber(deliverables);
      const deliverableLabel = deliverables === 1 ? 'Deliverable' : 'Deliverables';
      const flags = [];
      if (campaign.rush) {
        flags.push({ key: 'rush', label: 'Rush timeline', urgent: true });
      }
      if (campaign.travelNeeded) {
        flags.push({ key: 'travel', label: 'Travel required' });
      }
      if (campaign.nicheCreators) {
        flags.push({ key: 'niche', label: 'Niche creators' });
      }
      return h('div', { className: 'campaign-card' },
        h('div', null,
          h('h3', null, campaign.name || 'Untitled Campaign'),
          h('div', { className: 'campaign-card-meta' },
            h('span', null, h('strong', null, brandLabel), 'Brand'),
            h('span', null, h('strong', null, quarterLabel), 'Timeline'),
            h('span', null, h('strong', null, deliverableDisplay), deliverableLabel),
            h('span', null, h('strong', null, budgetDisplay), 'Target Budget'),
            h('span', null, h('strong', null, creatorLabel), 'Creators'),
            h('span', null, h('strong', null, viewLabel), 'Estimated Views'),
          ),
          flags.length
            ? h('div', { className: 'campaign-card-flags' }, flags.map(flag =>
                h('span', {
                  key: flag.key,
                  className: flag.urgent ? 'campaign-flag campaign-flag-urgent' : 'campaign-flag',
                }, flag.label),
              ))
            : null,
        ),
        h('div', { className: 'campaign-card-actions' },
          h('button', { onClick: () => onEdit(campaign.id) }, 'Edit'),
          h('button', { className: 'secondary', onClick: () => onDuplicate(campaign.id) }, 'Duplicate'),
          h('button', { className: 'secondary', onClick: () => onExport(campaign.id) }, 'Export CSV'),
          h('button', { className: 'danger', onClick: () => onDelete(campaign.id) }, 'Delete'),
        ),
      );
    }

    function CampaignDashboard({
      campaigns,
      onEdit,
      onDuplicate,
      onDelete,
      onCreate,
      templates,
      selectedTemplateId,
      onTemplateChange,
      onShowPricing,
      onExport,
      onLogout,
    }) {
      const options = [
        h('option', { key: 'blank', value: '' }, 'Start from template (optional)'),
        ...templates.map(template => h('option', { key: template.id, value: template.id }, template.name)),
      ];
      return h('div', { className: 'campaign-app' },
        h('div', { className: 'campaign-toolbar' },
          h('div', null,
            h('h2', null, 'Campaigns'),
            h('p', null, 'Manage saved campaigns, duplicate work, or start something new.'),
          ),
          h('div', { className: 'campaign-toolbar-actions' },
            h('button', { className: 'secondary', onClick: onShowPricing }, 'Pricing Variables'),
            h('select', {
              value: selectedTemplateId,
              onChange: event => onTemplateChange(event.target.value),
            }, options),
            h('button', { onClick: onCreate }, 'New Campaign'),
            h('button', { className: 'secondary', onClick: onLogout }, 'Logout'),
          ),
        ),
        campaigns.length
          ? h('div', { className: 'campaign-list' }, campaigns.map(campaign =>
              h(CampaignCard, {
                key: campaign.id,
                campaign,
                onEdit,
                onDuplicate,
                onDelete,
                onExport: onExport,
              }),
            ))
          : h('p', { className: 'campaign-dashboard-empty' }, 'No campaigns yet. Create a new campaign to get started.'),
      );
    }

    function EditorToolbar({ campaign, onBack, onSaveTemplate, onExport, onShowPricing, onLogout }) {
      const contextLabel = campaign ? `Editing ${campaign.name}` : 'Select a campaign to begin.';
      return h('div', { className: 'campaign-app' },
        h('div', { className: 'campaign-toolbar' },
          h('div', null,
            h('h2', null, 'Campaign Editor'),
            h('p', null, contextLabel),
          ),
          h('div', { className: 'campaign-toolbar-actions' },
            h('button', { className: 'secondary', onClick: onBack }, 'Back to Campaigns'),
            h('button', { className: 'secondary', onClick: onShowPricing }, 'Pricing Variables'),
            h('button', { className: 'secondary', onClick: onExport }, 'Export CSV'),
            h('button', { onClick: onSaveTemplate }, 'Save as Template'),
            h('button', { className: 'secondary', onClick: onLogout }, 'Logout'),
          ),
        ),
      );
    }

    function CampaignApp() {
      const { logout } = useAuth();
      const initialRef = useRef(null);
      if (!initialRef.current) {
        const initialCampaigns = bootstrapCampaigns();
        const initialRoute = parseRoute(initialCampaigns);
        const initialView = initialCampaigns.length ? initialRoute.view : 'dashboard';
        const initialActiveId = initialView === 'editor'
          && initialRoute.id
          && initialCampaigns.some(campaign => campaign.id === initialRoute.id)
          ? initialRoute.id
          : initialCampaigns[0]?.id ?? null;
        initialRef.current = {
          campaigns: initialCampaigns,
          view: initialView,
          activeId: initialActiveId,
        };
      }

      const initialData = initialRef.current;
      const [campaigns, setCampaigns] = useState(initialData.campaigns);
      const [view, setView] = useState(initialData.view);
      const [activeCampaignId, setActiveCampaignId] = useState(initialData.activeId);
      const [templates, setTemplates] = useState(() => loadTemplates());
      const [selectedTemplateId, setSelectedTemplateId] = useState('');
      const [pricingMenuOpen, setPricingMenuOpen] = useState(false);
      const campaignsRef = useRef(campaigns);

      useEffect(() => {
        campaignsRef.current = campaigns;
      }, [campaigns]);

      useEffect(() => {
        saveCampaigns(campaigns);
      }, [campaigns]);

      useEffect(() => {
        saveTemplates(templates);
      }, [templates]);

      useEffect(() => {
        document.body.classList.toggle('dashboard-active', view === 'dashboard');
      }, [view]);

      useEffect(() => {
        setPricingMenuOpen(false);
      }, [view]);

      useEffect(() => {
        if (!activeCampaignId) {
          persistActiveCampaign = () => {};
          return () => {
            persistActiveCampaign = () => {};
          };
        }
        persistActiveCampaign = updatedState => {
          setCampaigns(prev => {
            if (!prev.some(campaign => campaign.id === activeCampaignId)) {
              return prev;
            }
            return prev.map(campaign =>
              campaign.id === activeCampaignId
                ? createCampaignRecord(updatedState, activeCampaignId)
                : campaign,
            );
          });
        };
        return () => {
          persistActiveCampaign = () => {};
        };
      }, [activeCampaignId]);

      useEffect(() => {
        if (campaigns.length === 0 && view !== 'dashboard') {
          setView('dashboard');
          setActiveCampaignId(null);
        } else if (
          view === 'editor'
          && activeCampaignId
          && !campaigns.some(campaign => campaign.id === activeCampaignId)
        ) {
          const fallback = campaigns[0]?.id ?? null;
          setActiveCampaignId(fallback);
          if (!fallback) {
            setView('dashboard');
          }
        }
      }, [campaigns, view, activeCampaignId]);

      useEffect(() => {
        if (view !== 'editor' || !activeCampaignId) return;
        const active = campaignsRef.current.find(campaign => campaign.id === activeCampaignId);
        if (active) {
          hydrateActiveCampaign(active.data);
        }
      }, [view, activeCampaignId]);

      useEffect(() => {
        updateRoute(view, activeCampaignId);
      }, [view, activeCampaignId]);

      useEffect(() => {
        const handleNavigation = () => {
          const route = parseRoute(campaignsRef.current);
          setView(previous => (previous === route.view ? previous : route.view));
          setActiveCampaignId(previous => {
            if (route.view !== 'editor') {
              return null;
            }
            const desiredId = route.id ?? campaignsRef.current[0]?.id ?? null;
            return previous === desiredId ? previous : desiredId;
          });
        };
        window.addEventListener('popstate', handleNavigation);
        window.addEventListener('hashchange', handleNavigation);
        return () => {
          window.removeEventListener('popstate', handleNavigation);
          window.removeEventListener('hashchange', handleNavigation);
        };
      }, []);

      const activeCampaign = useMemo(
        () => campaigns.find(campaign => campaign.id === activeCampaignId) || null,
        [campaigns, activeCampaignId],
      );

      const handleTemplateChange = useCallback(value => {
        setSelectedTemplateId(value);
      }, []);

      const handleShowPricing = useCallback(() => {
        setPricingMenuOpen(true);
      }, []);

      const handleClosePricing = useCallback(() => {
        setPricingMenuOpen(false);
      }, []);

      const handleCreateCampaign = useCallback(() => {
        const template = templates.find(item => item.id === selectedTemplateId);
        const seededState = applyTemplateToState(structuredClone(defaultState), template);
        const label = template ? `${template.name} Campaign` : undefined;
        const record = createCampaignRecord(seededState, createId(), label);
        setCampaigns(prev => [...prev, record]);
        setActiveCampaignId(record.id);
        setView('editor');
      }, [templates, selectedTemplateId]);

      const handleEditCampaign = useCallback(id => {
        setActiveCampaignId(id);
        setView('editor');
      }, []);

      const handleDuplicateCampaign = useCallback(id => {
        let duplicate = null;
        setCampaigns(prev => {
          const source = prev.find(campaign => campaign.id === id);
          if (!source) {
            return prev;
          }
          duplicate = createCampaignRecord(
            source.data,
            createId(),
            `Copy of ${source.name || 'Campaign'}`,
          );
          return [...prev, duplicate];
        });
        if (duplicate) {
          setActiveCampaignId(duplicate.id);
          setView('editor');
        }
      }, []);

      const handleDeleteCampaign = useCallback(id => {
        setCampaigns(prev => prev.filter(campaign => campaign.id !== id));
        setActiveCampaignId(previous => (previous === id ? null : previous));
        setView(previous => (previous === 'editor' && activeCampaignId === id ? 'dashboard' : previous));
      }, [activeCampaignId]);

      const handleBackToDashboard = useCallback(() => {
        setView('dashboard');
        setActiveCampaignId(null);
      }, []);

      const handleSaveTemplate = useCallback(() => {
        const lines = sanitizeTemplateLines(state);
        const defaultName = state.details?.campaignName
          ? `${state.details.campaignName} Template`
          : 'New Template';
        const entered = prompt('Template name', defaultName);
        if (!entered) return;
        const trimmed = entered.trim();
        if (!trimmed) return;
        let newTemplateId = null;
        setTemplates(prev => {
          const existing = prev.find(template => template.name.toLowerCase() === trimmed.toLowerCase());
          const payload = {
            id: existing?.id ?? createId(),
            name: trimmed,
            deliverables: lines,
          };
          newTemplateId = payload.id;
          if (existing) {
            return prev.map(template => (template.id === existing.id ? payload : template));
          }
          return [...prev, payload];
        });
        setSelectedTemplateId(newTemplateId);
      }, []);

      const handleExportCampaign = useCallback(id => {
        const collection = campaignsRef.current || [];
        const target = collection.find(entry => entry.id === id);
        if (target) {
          exportCampaignToCSV(target);
        }
      }, []);

      const handleExportActive = useCallback(() => {
        const exportRecord = createCampaignRecord(state, activeCampaign?.id, activeCampaign?.name);
        exportCampaignToCSV(exportRecord);
      }, [activeCampaign]);

      return view === 'dashboard'
        ? h(React.Fragment, null,
            h(CampaignDashboard, {
              campaigns,
              onEdit: handleEditCampaign,
              onDuplicate: handleDuplicateCampaign,
              onDelete: handleDeleteCampaign,
              onCreate: handleCreateCampaign,
              templates,
              selectedTemplateId,
              onTemplateChange: handleTemplateChange,
              onShowPricing: handleShowPricing,
              onExport: handleExportCampaign,
              onLogout: logout,
            }),
            pricingMenuOpen ? h(PricingVariablesMenu, { onClose: handleClosePricing }) : null,
          )
        : h(React.Fragment, null,
            h(EditorToolbar, {
              campaign: activeCampaign,
              onBack: handleBackToDashboard,
              onSaveTemplate: handleSaveTemplate,
              onExport: handleExportActive,
              onShowPricing: handleShowPricing,
              onLogout: logout,
            }),
            pricingMenuOpen ? h(PricingVariablesMenu, { onClose: handleClosePricing }) : null,
          );
    }

    function mountRootApp() {
      if (!hasReact) return;
      const container = document.getElementById('campaign-app');
      if (!container) return;
      if (!container.__picRoot) {
        container.__picRoot = ReactDOM.createRoot(container);
      }
      container.__picRoot.render(h(RootApp));
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('unauthenticated');
      mountRootApp();
    });

    // placeholder for future EMPTY workbook parsing hook
    function parseEmptyDump(text) {
      console.log('Parser placeholder for EMPTY tab dump', text);
    }
  </script>
</body>
</html>
